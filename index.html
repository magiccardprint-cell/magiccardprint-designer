<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MagicCardPrint - Badge Designer</title>
    
    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- JsBarcode for real barcodes -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- QRCode Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #000000;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .content {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 0;
        }

        /* Sidebar */
        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 2px solid #e0e0e0;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-template {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            position: relative;
            animation: pulse 2s infinite;
        }

        .btn-template::before {
            content: "‚≠ê NEW";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }

        .btn-artwork {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            animation: pulse-artwork 2s infinite;
        }

        .btn-artwork::before {
            content: "üì§ NEW";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        }

        @keyframes pulse-artwork {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            margin-top: 10px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
            margin-top: 10px;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
            margin-top: 10px;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .tool-btn {
            padding: 15px 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .tool-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        /* Custom Fields */
        .custom-fields-list {
            margin-top: 15px;
        }

        .custom-field-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .custom-field-row {
            display: grid;
            grid-template-columns: 185px 185px 36px;
            gap: 8px;
            align-items: center;
        }

        .custom-field-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
        }

        .btn-remove {
            width: 36px;
            height: 36px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .btn-add-field {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        /* Text Formatting */
        .text-controls {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 6px;
            border: 2px solid #ffc107;
        }

        .text-controls.show {
            display: block;
        }

        .layer-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .layer-btn {
            padding: 8px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .layer-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        /* Canvas Area */
        .canvas-area {
            padding: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .tab {
            padding: 12px 24px;
            background: #e0e0e0;
            border: none;
            border-radius: 6px 6px 0 0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab.disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .tab.disabled {
            background: #f5f5f5;
            color: #bbb;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .tab.disabled:hover {
            background: #f5f5f5;
        }

        .canvas-wrapper {
            text-align: center;
            padding: 30px;
            background: #fafafa;
            border-radius: 8px;
            border: 3px dashed #ddd;
        }

        #canvas {
            border: 3px solid #cccccc;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            background: white;
            border-radius: 12px;
        }

        .canvas-info {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            font-size: 14px;
            color: #856404;
        }

        .security-info {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: 3px solid #0c5460;
            border-radius: 8px;
            font-size: 14px;
            color: #0c5460;
            position: relative;
            box-shadow: 0 4px 12px rgba(12, 84, 96, 0.2);
        }

        .security-info strong {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .security-shield {
            display: inline-block;
            width: 32px;
            height: 32px;
            margin-right: 12px;
            animation: pulse-shield 2s infinite;
        }

        @keyframes pulse-shield {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        /* Shape color controls */
        .shape-controls {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 6px;
            border: 2px solid #2196F3;
        }

        .shape-controls.show {
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #667eea;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .template-card {
            border: 3px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .template-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .template-preview {
            width: 100%;
            height: 150px;
            background: #f0f0f0;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
        }

        .template-name {
            font-weight: 600;
            color: #333;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #28a745;
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10001;
            display: none;
            font-weight: 600;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        input[type="file"] {
            display: none;
        }

        .excel-upload-section {
            margin-top: 15px;
            padding: 15px;
            background: #e7f3ff;
            border: 2px solid #2196F3;
            border-radius: 6px;
        }

        .checkbox-group {
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .checkbox-group label {
            display: inline;
            font-size: 13px;
            font-weight: 600;
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
            .template-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MagicCardPrint Badge Designer</h1>
            <p>Design custom PVC ID badges with unlimited fields & templates</p>
            <a href="#" onclick="confirmExit()" style="display: inline-block; margin-top: 15px; padding: 10px 25px; background: white; color: #000; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;">‚Üê Back to MagicCardPrint</a>
            <div style="margin-top: 12px; padding: 8px 15px; background: rgba(255,255,255,0.2); border-radius: 6px; display: inline-block;">
                <span style="color: #fff; font-size: 13px;">üíª Badge designer is best viewed on desktop for optimal design experience</span>
            </div>
        </div>

        <div class="content">
            
            <!-- Sidebar -->
            <div class="sidebar">
                
                <!-- Specifications -->
                <div class="section">
                    <div class="section-title">‚öôÔ∏è Badge Specs</div>
                    
                    <div class="form-group">
                        <label class="form-label">Style</label>
                        <select class="form-select" id="badgeStyle" onchange="updateBadgeStyle()">
                            <option value="single">Single Sided (Front Only)</option>
                            <option value="double">Double Sided (Front & Back) +$1.00</option>
                        </select>
                        <p style="font-size: 11px; color: #dc3545; font-weight: 600; margin-top: 5px; display: none;" id="doubleSidedNote">
                            ‚úì +$1.00 added to unit price for double-sided printing
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Card Type 
                            <button onclick="openCardSizeInfo()" style="background: #2196F3; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; margin-left: 5px; line-height: 1;">‚ÑπÔ∏è</button>
                        </label>
                        <select class="form-select" id="cardType" onchange="updateCardType()">
                            <option value="standard">Standard CR80 ID Card (2.125" x 3.375")</option>
                            <option value="magnetic" id="magneticOption">Standard CR80 ID Card with Magnetic Stripe</option>
                            <option value="adhesive">CR80 Adhesive Cards PVC Overlays</option>
                        </select>
                        <p id="magneticPriceNote" style="display: none; color: #28a745; font-size: 12px; margin-top: 5px; font-weight: 600;">
                            ‚úì +$3.00 added to unit price for magnetic stripe card
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Orientation</label>
                        <select class="form-select" id="orientation" onchange="changeOrientation()">
                            <option value="landscape">Landscape</option>
                            <option value="portrait">Portrait</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Hole/Slot</label>
                        <select class="form-select" id="holeSlot" onchange="updateSlotVisual()">
                            <option value="none">No Slot</option>
                            <option value="lanyard">Standard Oval Hole</option>
                        </select>
                    </div>
                </div>

                <!-- Template Selection -->
                <div class="section">
                    <div class="section-title">üé® Templates</div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        Select from different designs from our template gallery.
                    </p>
                    <button class="btn btn-template" onclick="openTemplateGallery()">
                        üìã Select from Template Gallery
                    </button>
                </div>

                <!-- Background Image -->
                <div class="section">
                    <div class="section-title">üñºÔ∏è Background Image</div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        This function applies a background image design to your badge.
                    </p>
                    <button class="btn btn-info" onclick="document.getElementById('backgroundInput').click()">
                        üåÑ Add Background Image
                    </button>
                    <input type="file" id="backgroundInput" accept="image/*" onchange="handleBackgroundUpload(event)">
                    <button class="btn btn-danger" onclick="removeBackground()" style="margin-top: 10px;">
                        üóëÔ∏è Remove Background
                    </button>
                </div>

                <!-- Add Elements -->
                <div class="section">
                    <div class="section-title">‚ûï Add Elements</div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        Add text, photos, logos, shapes, barcodes, or QR codes to your layout.
                    </p>
                    
                    <div class="tool-grid">
                        <button class="tool-btn" onclick="addTextElement()">üìù Text</button>
                        <button class="tool-btn" onclick="document.getElementById('photoInput').click()">üì∑ Photo</button>
                        <button class="tool-btn" onclick="document.getElementById('logoInput').click()">üè¢ Logo</button>
                        <button class="tool-btn" onclick="addRectangleElement()">‚ñ¢ Rectangle</button>
                        <button class="tool-btn" onclick="addCircleElement()">‚óè Circle</button>
                        <button class="tool-btn" onclick="openBarcodeDialog()">||| Barcode</button>
                        <button class="tool-btn" onclick="openQRCodeDialog()">‚ñ¶ QR Code</button>
                    </div>

                    <input type="file" id="photoInput" accept="image/*" onchange="handleImageUpload(event)">
                    <input type="file" id="logoInput" accept="image/*" onchange="handleImageUpload(event)">
                </div>

                <!-- Text Formatting (shows when text selected) -->
                <div class="text-controls" id="textControls">
                    <div class="section-title" style="margin-bottom: 10px;">‚úèÔ∏è Text Formatting</div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        Press enter to reflect the changes
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">Font Family</label>
                        <select class="form-select" id="fontFamily" onchange="updateTextFormat()">
                            <option>Arial</option>
                            <option>Helvetica</option>
                            <option>Times New Roman</option>
                            <option>Georgia</option>
                            <option>Verdana</option>
                            <option>Impact</option>
                            <option>Courier New</option>
                            <option>Comic Sans MS</option>
                            <option>Trebuchet MS</option>
                            <option>Palatino</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Font Size</label>
                        <input type="number" class="form-input" id="fontSize" min="8" max="120" value="24" onchange="updateTextFormat()">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Font Color</label>
                        <input type="color" class="form-input" id="textColor" value="#000000" onchange="updateTextFormat()">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Font Weight</label>
                        <select class="form-select" id="fontWeight" onchange="updateTextFormat()">
                            <option value="normal">Normal</option>
                            <option value="bold">Bold</option>
                        </select>
                    </div>
                </div>

                <!-- Shape Color Controls (shows when shape selected) -->
                <div class="shape-controls" id="shapeControls">
                    <div class="section-title" style="margin-bottom: 10px;">üé® Shape Color</div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        Press enter to reflect the changes
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">Fill Color</label>
                        <input type="color" class="form-input" id="shapeFillColor" value="#667eea" onchange="updateShapeColor()">
                    </div>
                </div>

                <!-- Layer Controls -->
                <div class="section">
                    <div class="section-title">üìö Layers</div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        This feature allows elements to be positioned in front of or behind other images.
                    </p>
                    <div class="layer-controls">
                        <button class="layer-btn" onclick="bringToFront()">‚¨ÜÔ∏è Bring to Front</button>
                        <button class="layer-btn" onclick="sendToBack()">‚¨áÔ∏è Send to Back</button>
                    </div>
                </div>

                <!-- Custom Fields -->
                <div class="section">
                    <div class="section-title">üìù Custom Fields</div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        Add unlimited custom fields in your layout.
                    </p>

                    <div class="custom-fields-list" id="customFieldsList">
                        <!-- Default fields -->
                        <div class="custom-field-item">
                            <div class="custom-field-row">
                                <input type="text" class="custom-field-input field-label" placeholder="Label" value="Full Name">
                                <input type="text" class="custom-field-input field-value" placeholder="Value">
                                <button class="btn-remove" onclick="removeField(this)">√ó</button>
                            </div>
                        </div>
                        <div class="custom-field-item">
                            <div class="custom-field-row">
                                <input type="text" class="custom-field-input field-label" placeholder="Label" value="Position">
                                <input type="text" class="custom-field-input field-value" placeholder="Value">
                                <button class="btn-remove" onclick="removeField(this)">√ó</button>
                            </div>
                        </div>
                        <div class="custom-field-item">
                            <div class="custom-field-row">
                                <input type="text" class="custom-field-input field-label" placeholder="Label" value="Employee ID">
                                <input type="text" class="custom-field-input field-value" placeholder="Value">
                                <button class="btn-remove" onclick="removeField(this)">√ó</button>
                            </div>
                        </div>
                    </div>

                    <button class="btn-add-field" onclick="addCustomField()">+ Add New Field</button>
                    
                    <button class="btn btn-primary" onclick="addAllFieldsToBadge()" style="margin-top: 15px;">
                        ‚ú® Add All Fields to Badge
                    </button>
                </div>

                <!-- Excel Bulk Upload -->
                <div class="section">
                    <div class="section-title">üìä Bulk Upload (Excel)</div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                        Upload an Excel file to print multiple badges with the same design by downloading the Excel template, adding your data as rows, and uploading the completed file using the Upload Excel File button below.
                    </p>

                    <button class="btn btn-warning" onclick="downloadExcelTemplate()">
                        üì• Download Excel Template
                    </button>

                    <button class="btn btn-primary" onclick="document.getElementById('excelInput').click()" style="margin-top: 15px;">
                        üìÅ Upload Excel File
                    </button>
                    <input type="file" id="excelInput" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">

                    <div class="excel-upload-section" id="excelSection" style="display:none;">
                        <p style="font-size: 13px; font-weight: 600; margin-bottom: 10px;">
                            ‚úÖ File uploaded: <span id="excelFileName"></span>
                        </p>
                        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                            Records found: <span id="excelRowCount">0</span>
                        </p>

                        <div class="checkbox-group">
                            <input type="checkbox" id="printAllBadges" checked>
                            <label for="printAllBadges">Print this design for all badges in Excel file</label>
                        </div>
                    </div>

                    <!-- Bulk Photos Upload Section (for badges with photos) -->
                    <div id="bulkPhotosSection" style="display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
                        <h4 style="color: #856404; margin-bottom: 10px; font-size: 14px;">üì∏ Upload Badge Photos (Optional)</h4>
                        <p style="font-size: 12px; color: #856404; margin-bottom: 12px; line-height: 1.5;">
                            If your badges include photos, upload them here. <strong>Important:</strong> Name each photo file to match the ID or Name in your Excel file.
                            <br><br>
                            <strong>Example:</strong> If Excel has "Employee ID: EMP001", name the photo "EMP001.jpg"
                        </p>
                        
                        <button class="btn btn-warning" onclick="document.getElementById('bulkPhotosInput').click()" style="width: 100%;">
                            üì§ Upload Photos (Multiple)
                        </button>
                        <input type="file" id="bulkPhotosInput" accept=".jpg,.jpeg,.png" multiple onchange="handleBulkPhotosUpload(event)" style="display: none;">
                        
                        <div id="bulkPhotosPreview" style="display: none; margin-top: 10px;">
                            <p style="font-size: 13px; font-weight: 600; color: #155724;">
                                ‚úÖ Photos uploaded: <span id="bulkPhotosCount">0</span>
                            </p>
                            <div id="bulkPhotosList" style="font-size: 11px; color: #666; max-height: 80px; overflow-y: auto; margin-top: 5px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="section">
                    <div class="section-title">üé¨ Actions</div>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        This function allows you to delete selected elements or clear the current side of the layout.
                    </p>
                    <button class="btn btn-secondary" onclick="deleteSelectedElement()">üóëÔ∏è Delete Selected</button>
                    <button class="btn btn-danger" onclick="clearCurrentCanvas()">üßπ Clear This Side</button>
                    <button class="btn btn-success" onclick="downloadCardSpecification()" style="margin-top: 15px;">üìÑ Download Card Specification</button>
                </div>

            </div>

            <!-- Canvas Area -->
            <div class="canvas-area">
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchToFront()">Front Side</button>
                    <button class="tab" id="backTab" onclick="switchToBack()">Back Side</button>
                </div>

                <!-- Upload Complete Artwork Button -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                    <button class="btn btn-artwork" onclick="openArtworkUpload()" style="width: auto; padding: 12px 24px;">
                        üì§ Upload Complete Artwork
                    </button>
                    <button class="btn" onclick="openPreview()" style="width: auto; padding: 12px 24px; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        üîç Preview Layout
                    </button>
                </div>

                <!-- Canvas -->
                <div class="canvas-wrapper">
                    <canvas id="canvas"></canvas>
                </div>

                <div class="canvas-info">
                    üí° <strong>Instructions:</strong> Click elements to select ‚Ä¢ Drag to move ‚Ä¢ Use corners to resize ‚Ä¢ Press Delete key to remove
                </div>

                <!-- Back Side Printing Restriction Warning -->
                <div id="backSideWarning" style="display: none; background: #dc3545; border: 3px solid #c82333; border-radius: 8px; padding: 18px; margin-top: 15px; color: #ffffff; font-weight: 600;">
                    <strong style="font-size: 15px;">‚ö†Ô∏è Back Side Printing Restriction:</strong><br>
                    <span style="font-size: 14px;">Back side can only print black color text and elements. Photos are not available on back side.</span>
                </div>

                <div class="security-info">
                    <strong>
                        <svg class="security-shield" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            <path d="M9 12l2 2 4-4"/>
                        </svg>
                        üîí HoloKote¬Æ Security Feature (FREE)
                    </strong>
                    All badges include FREE HoloKote¬Æ security features that prevent unauthorized duplication. This patented watermark technology adds anti-fraud protection visible when the card is tilted in light. No additional charges!
                    <br>
                    <a href="https://magicard.com/holokote/" target="_blank" style="color: #0c5460; font-weight: 600; text-decoration: underline; margin-top: 8px; display: inline-block;">Learn more about security features ‚Üí</a>
                </div>

                <!-- Summary -->
                <div class="summary" style="margin-top: 30px; padding: 25px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e0e0e0;">
                    <h3 style="font-size: 18px; color: #667eea; margin-bottom: 20px;">üìã Order Summary</h3>

                    <div class="price-box" style="background: white; padding: 20px; border-radius: 6px; border: 2px solid #667eea;">
                        
                        <!-- Order Type Selection -->
                        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">Order Type:</label>
                            
                            <div style="margin-bottom: 8px;">
                                <input type="radio" name="orderType" id="orderTypeSingle" value="single" checked onchange="updatePriceByType()">
                                <label for="orderTypeSingle" style="display: inline; margin-left: 5px; cursor: pointer;">
                                    <strong>Single Piece</strong> - $30.00 each
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 8px;">
                                <input type="radio" name="orderType" id="orderTypeBulk1" value="bulk1" onchange="updatePriceByType()">
                                <label for="orderTypeBulk1" style="display: inline; margin-left: 5px; cursor: pointer;">
                                    <strong>Bulk Order (2-50)</strong> - $15.00 each
                                </label>
                            </div>
                            
                            <div>
                                <input type="radio" name="orderType" id="orderTypeBulk2" value="bulk2" onchange="updatePriceByType()">
                                <label for="orderTypeBulk2" style="display: inline; margin-left: 5px; cursor: pointer;">
                                    <strong>Bulk Order (51-100+)</strong> - $12.00 each
                                </label>
                            </div>
                        </div>

                        <div class="price-row" style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 15px;">
                            <span>Quantity:</span>
                            <input type="number" id="quantity" min="1" max="500" value="1" 
                                   style="width:80px;padding:8px;border:1px solid #ddd;border-radius:4px;" 
                                   onchange="updatePriceByType()">
                        </div>
                        <div class="price-row" style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 15px;">
                            <span>Unit Price:</span>
                            <span id="unitPrice">$30.00</span>
                        </div>
                        <div class="price-row total" style="display: flex; justify-content: space-between; border-top: 2px solid #e0e0e0; padding-top: 12px; margin-top: 12px; font-size: 22px; font-weight: 700; color: #667eea;">
                            <span>Total:</span>
                            <span id="totalPrice">$30.00</span>
                        </div>
                    </div>

                    <!-- Free Shipping Message -->
                    <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 6px; padding: 12px; margin-top: 15px; text-align: center;">
                        <span style="color: #155724; font-weight: 600; font-size: 14px;">
                            üöö Free shipping on every order ‚Äî no minimum.
                        </span>
                    </div>

                    <!-- Additional Instructions -->
                    <div style="margin-top: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Additional Instructions (Optional):</label>
                        <textarea id="additionalInstructions" placeholder="Enter any special instructions for your order..." 
                                  style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; font-family: Arial, sans-serif; resize: vertical;"></textarea>
                    </div>

                    <!-- Delivery Date Picker -->
                    <div style="margin-top: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Choose Delivery Date:</label>
                        <input type="date" id="deliveryDate" 
                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;"
                               onchange="validateDeliveryDate()">
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            ‚è∞ Production time: 3-7 business days from order date
                        </p>
                    </div>

                    <!-- Proof Approval Checkbox -->
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="proofApproval" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                            <span style="font-size: 14px; color: #856404; font-weight: 600;">
                                Please send the final proof design for my approval before starting production
                            </span>
                        </label>
                    </div>

                    <!-- Bulk Order Excel Confirmation Checkbox -->
                    <div id="bulkOrderConfirmation" style="display: none; margin-top: 15px; padding: 15px; background: #e7f3ff; border: 2px solid #2196F3; border-radius: 6px;">
                        <label style="display: flex; align-items: flex-start; cursor: pointer;">
                            <input type="checkbox" id="bulkExcelConfirm" style="width: 20px; height: 20px; margin-right: 10px; margin-top: 2px; cursor: pointer;">
                            <span style="font-size: 14px; color: #0c5460; font-weight: 600;">
                                I have uploaded my bulk order Excel file with all badge data (names, positions, photos, etc.)
                            </span>
                        </label>
                        <p style="font-size: 12px; color: #0c5460; margin-top: 8px; margin-left: 30px;">
                            ‚ö†Ô∏è Required for bulk orders. Your Excel file will be saved with your order.
                        </p>
                    </div>

                    <button class="btn btn-primary" id="checkoutBtn" onclick="checkout()" style="margin-top: 20px;" disabled>
                        üõí Add to Cart & Checkout
                    </button>
                    
                    <p id="checkoutDisabledMsg" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: block;">
                        ‚ö†Ô∏è Add at least one element to your badge design to enable checkout
                    </p>

                    <button class="btn btn-secondary" onclick="exportBothSides()">
                        üíæ Download Design Files (PNG)
                    </button>
                </div>

            </div>

        </div>
    </div>

    <!-- Template Gallery Modal -->
    <div class="modal" id="templateModal">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh;">
            <button class="modal-close" onclick="closeTemplateGallery()">√ó</button>
            <h2 class="modal-title">üìã Select a Template</h2>
            <p style="color: #666; margin-bottom: 15px;">Choose a pre-designed template to start your badge design</p>
            
            <!-- Search and Filter -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" id="templateSearch" placeholder="üîç Search templates..." 
                       onkeyup="filterTemplates()" 
                       style="flex: 1; min-width: 200px; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                <select id="templateCategory" onchange="filterTemplates()" 
                        style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; min-width: 180px;">
                    <option value="all">All Categories</option>
                    <!-- Categories loaded dynamically from Cloudinary -->
                </select>
            </div>
            
            <div style="max-height: 55vh; overflow-y: auto;">
                <div class="template-grid" id="templateGrid">
                    <!-- Templates will be loaded from Cloudinary -->
                </div>
            </div>
            
            <p style="color: #667eea; font-size: 12px; margin-top: 15px; text-align: center;">
                üí° Templates are loaded from our cloud gallery. Add more templates anytime!
            </p>
        </div>
    </div>

    <!-- Barcode Dialog Modal -->
    <div class="modal" id="barcodeModal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeBarcodeDialog()">√ó</button>
            <h2 class="modal-title">||| Add Barcode</h2>

            <div class="form-group">
                <label class="form-label">Barcode Type</label>
                <select class="form-select" id="barcodeType">
                    <option value="Code39">Code 39</option>
                    <option value="Code128">Code 128</option>
                    <option value="UPCA">UPC-A</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Barcode Value (Numbers/Letters)</label>
                <input type="text" class="form-input" id="barcodeValue" placeholder="e.g., 123456789">
                <p style="font-size: 11px; color: #666; margin-top: 5px;">
                    Code 39: Letters & numbers ‚Ä¢ Code 128: Any ASCII ‚Ä¢ UPC-A: 12 digits
                </p>
            </div>

            <button class="btn btn-primary" onclick="addBarcodeWithValue()">
                ‚úÖ Add Real Barcode to Badge
            </button>
        </div>
    </div>

    <!-- QR Code Dialog Modal -->
    <div class="modal" id="qrcodeModal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeQRCodeDialog()">√ó</button>
            <h2 class="modal-title">‚ñ¶ Add QR Code</h2>

            <div class="form-group">
                <label class="form-label">QR Code Data</label>
                <input type="text" class="form-input" id="qrcodeValue" placeholder="e.g., https://company.com or employee data">
                <p style="font-size: 11px; color: #666; margin-top: 5px;">
                    Enter URL, text, numbers, or any data you want to encode
                </p>
            </div>

            <button class="btn btn-primary" onclick="addQRCodeWithValue()">
                ‚úÖ Add Real QR Code to Badge
            </button>
        </div>
    </div>

    <!-- Card Size Info Modal -->
    <div class="modal" id="cardSizeModal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="modal-close" onclick="closeCardSizeInfo()">√ó</button>
            <h2 class="modal-title">üìè CR80 ID Card Size Information</h2>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #2196F3; margin-bottom: 15px; font-size: 18px;">What is CR80?</h3>
                <p style="margin-bottom: 15px; line-height: 1.6;">
                    <strong>CR80</strong> is the most common ID card size and is the same size as a standard credit card. 
                    The "CR" stands for "Card, Rectangular" and is part of the ISO/IEC 7810 international standard.
                </p>
                
                <div style="background: white; padding: 15px; border-radius: 6px; border: 2px solid #2196F3; margin-bottom: 15px;">
                    <h4 style="color: #000; margin-bottom: 10px;">üìê CR80 Dimensions:</h4>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Width:</strong> 3.375 inches (85.6 mm)</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Height:</strong> 2.125 inches (53.98 mm)</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Thickness:</strong> 0.030 inches (0.76 mm)</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Corner Radius:</strong> 0.125 inches (3.18 mm)</li>
                    </ul>
                </div>

                <h4 style="color: #000; margin-bottom: 10px;">üí≥ Common Uses:</h4>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>Employee ID cards</li>
                    <li>Access control cards</li>
                    <li>Membership cards</li>
                    <li>Student ID cards</li>
                    <li>Insurance cards</li>
                    <li>Gift cards</li>
                </ul>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border: 1px solid #ffc107; margin-bottom: 15px;">
                <h4 style="color: #856404; margin-bottom: 10px;">üîß Magnetic Stripe Option:</h4>
                <p style="color: #856404; margin: 0; line-height: 1.6;">
                    The magnetic stripe version includes a black magnetic stripe on the back of the card, 
                    commonly used for access control systems, time tracking, or payment applications.
                </p>
            </div>

            <button class="btn btn-primary" onclick="closeCardSizeInfo()" style="margin-top: 15px;">
                ‚úÖ Got It!
            </button>
        </div>
    </div>

    <!-- Artwork Upload Modal -->
    <div class="modal" id="artworkModal">
        <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeArtworkUpload()">√ó</button>
            <h2 class="modal-title">üì§ Upload Complete Artwork</h2>

            <p style="margin-bottom: 15px; line-height: 1.6; color: #666;">
                Please upload the full artwork for two layouts (front and back, if applicable): one showing the complete design with all variable fields and one showing only the fixed background without variable fields, to clearly communicate the requested card layout. Press the Upload Artwork button below.
            </p>
            
            <div style="background: #e7f3ff; border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <p style="color: #0c5460; font-size: 14px; line-height: 1.6; margin: 0;">
                    <strong>üí° Important:</strong> Don't forget to add the completed artwork on the canvas by adding a photo on the Add Elements panel. This way we can preview what the layout looks like. If this is a bulk order, make sure to download the Excel template, add your data, and upload the completed Excel file with all the data based on the fields in your design (Front side and Back side if applicable).
                </p>
            </div>

            <!-- Accordion Section 1: Artwork Guidelines -->
            <div style="border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px;">
                <button onclick="toggleAccordion('artwork-guidelines')" 
                        style="width: 100%; padding: 15px; background: #f8f9fa; border: none; text-align: left; font-weight: 700; font-size: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 6px;">
                    <span>üìã Artwork Guidelines</span>
                    <span id="artwork-guidelines-icon">‚ñº</span>
                </button>
                <div id="artwork-guidelines" style="display: none; padding: 20px; background: white;">
                    <h4 style="color: #2196F3; margin-bottom: 15px;">Graphic Elements</h4>
                    
                    <ul style="line-height: 1.8; margin-left: 20px; margin-bottom: 20px;">
                        <li><strong>File Format:</strong> High resolution .jpg files are preferred</li>
                        <li><strong>Color Separation:</strong> RGB</li>
                        <li><strong>Minimum Resolution:</strong> 300 DPI (600 DPI is preferred at 100%)</li>
                        <li><strong>Accepted File Types:</strong> .jpg, .png for logos and graphics</li>
                    </ul>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è Important: Upload Requirements</h4>
                        <p style="color: #856404; line-height: 1.6; margin-bottom: 10px;">
                            Please upload <strong>TWO versions</strong> of your artwork (for both Front and Back if double-sided):
                        </p>
                        <ol style="color: #856404; line-height: 1.8; margin-left: 20px;">
                            <li><strong>Complete Layout Example:</strong> Including sample photo, name, and all variable fields</li>
                            <li><strong>Fixed Background Only:</strong> Just the background design without any variable fields</li>
                        </ol>
                        <p style="color: #856404; line-height: 1.6; margin-top: 10px; font-size: 13px;">
                            This allows us to clearly understand your requested card layout and apply variable data correctly.
                        </p>
                    </div>

                    <ul style="line-height: 1.8; margin-left: 20px; margin-bottom: 15px;">
                        <li><strong>Logo & Images:</strong> Upload original company logo, images, or illustrations for better resolution</li>
                        <li><strong>Legal Rights:</strong> Ensure you have legal rights to use provided logos/artwork. We are not liable for unauthorized use</li>
                        <li><strong>Fonts:</strong> Specify any required fonts. Uncommon fonts must be provided - upload font files if necessary</li>
                        <li><strong>Font Limitations:</strong> Some non-standard fonts may not render exactly as expected due to printer limitations</li>
                    </ul>
                </div>
            </div>

            <!-- Accordion Section 2: Color Matching -->
            <div style="border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 20px;">
                <button onclick="toggleAccordion('color-matching')" 
                        style="width: 100%; padding: 15px; background: #f8f9fa; border: none; text-align: left; font-weight: 700; font-size: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 6px;">
                    <span>üé® Color Matching Information</span>
                    <span id="color-matching-icon">‚ñº</span>
                </button>
                <div id="color-matching" style="display: none; padding: 20px; background: white;">
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        We will make every effort to closely match your company's colors. However, please note:
                    </p>

                    <ul style="line-height: 1.8; margin-left: 20px; margin-bottom: 15px;">
                        <li>Precise matching to Pantone Matching System (PMS) numbers may not be possible</li>
                        <li>Colors may vary based on printers used and may differ over time due to technology upgrades</li>
                        <li><strong>Difficult Colors:</strong> Teal and Burgundy are particularly challenging and may require additional costs</li>
                    </ul>

                    <div style="background: #e7f3ff; padding: 15px; border-radius: 6px; border-left: 4px solid #2196F3; margin-bottom: 15px;">
                        <h4 style="color: #0c5460; margin-bottom: 10px;">üí° Important Notes:</h4>
                        <ul style="color: #0c5460; line-height: 1.8; margin-left: 20px;">
                            <li>Screen colors may not accurately represent final printed colors</li>
                            <li>Final product colors may differ from RGB, CMYK, or PMS numbers due to dye-sublimation printing process</li>
                            <li>Heat used in printing and industry standard variations can affect final color</li>
                        </ul>
                    </div>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üè¢ For Precise Color Matching:</h4>
                        <p style="color: #856404; line-height: 1.6;">
                            Organizations requiring exact color matching must pre-order custom-printed stock. This requires a 20-business-day lead time and may incur additional costs.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Hidden File Input -->
                <input type="file" id="artworkFiles" accept=".jpg,.jpeg,.png" multiple 
                       onchange="handleArtworkFilesSelected()"
                       style="display: none;">
                
                <!-- Upload Button -->
                <button class="btn btn-primary" onclick="document.getElementById('artworkFiles').click()" 
                        style="width: 100%; padding: 15px; font-size: 16px;">
                    ‚úÖ Upload Artwork
                </button>
                
                <!-- Upload Count Text -->
                <div id="artworkUploadCount" style="text-align: center; color: #28a745; font-weight: 600; font-size: 14px; min-height: 20px;">
                    <!-- Upload count will appear here -->
                </div>
                
                <!-- Cancel Button -->
                <button class="btn btn-secondary" onclick="closeArtworkUpload()" 
                        style="width: 100%; padding: 15px; font-size: 16px;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeCheckoutModal()">√ó</button>
            <h2 class="modal-title">üõí Submit Design & Checkout</h2>
            
            <div id="checkoutStep1">
                <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">
                    Your design will be securely saved and you'll be redirected to our payment page.
                </p>

                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-input" id="checkoutName" placeholder="John Smith" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Email Address *</label>
                    <input type="email" class="form-input" id="checkoutEmail" placeholder="john@example.com" required>
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin-bottom: 10px; color: #333;">Order Summary</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Quantity:</span>
                        <span id="checkoutQuantity">1</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Unit Price:</span>
                        <span id="checkoutUnitPrice">$30.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 18px; padding-top: 10px; border-top: 2px solid #e0e0e0;">
                        <span>Total:</span>
                        <span id="checkoutTotal">$30.00</span>
                    </div>
                </div>

                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #2e7d32; font-size: 14px; margin: 0;">
                        ‚úÖ FREE Shipping<br>
                        üîí HoloKote Security Included<br>
                        üìß Order confirmation via email
                    </p>
                </div>

                <button class="btn btn-primary" onclick="processCheckout()" id="checkoutSubmitBtn" style="font-size: 16px; padding: 15px;">
                    Submit Design & Pay ‚Üí
                </button>
                
                <button class="btn btn-secondary" onclick="closeCheckoutModal()">
                    Cancel
                </button>
            </div>

            <div id="checkoutStep2" style="display: none; text-align: center; padding: 30px 0;">
                <div style="width: 60px; height: 60px; border: 4px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <h3 style="margin-bottom: 10px;">Processing Your Order</h3>
                <p id="checkoutStatus" style="color: #666;">Uploading your design...</p>
            </div>

            <div id="checkoutStep3" style="display: none; text-align: center; padding: 30px 0;">
                <div style="width: 60px; height: 60px; background: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <span style="color: white; font-size: 30px;">‚úì</span>
                </div>
                <h3 style="margin-bottom: 10px;">Design Uploaded!</h3>
                <p style="color: #666; margin-bottom: 10px;">Reference ID: <strong id="checkoutRefId"></strong></p>
                <p style="color: #666;">Redirecting to payment...</p>
            </div>

            <div id="checkoutError" style="display: none; text-align: center; padding: 30px 0;">
                <div style="width: 60px; height: 60px; background: #dc3545; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <span style="color: white; font-size: 30px;">‚úï</span>
                </div>
                <h3 style="margin-bottom: 10px; color: #dc3545;">Something Went Wrong</h3>
                <p id="checkoutErrorMsg" style="color: #666; margin-bottom: 20px;">Please try again.</p>
                <button class="btn btn-primary" onclick="retryCheckout()">Try Again</button>
                <button class="btn btn-secondary" onclick="closeCheckoutModal()">Cancel</button>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Preview Layout Modal -->
    <div class="modal" id="previewModal">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; width: auto; padding: 20px;">
            <button class="modal-close" onclick="closePreview()">√ó</button>
            <h2 class="modal-title">üîç Preview Layout</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; justify-content: center;">
                <button id="previewFrontBtn" class="btn btn-primary" onclick="showPreviewSide('front')" style="padding: 10px 20px;">
                    Front Side
                </button>
                <button id="previewBackBtn" class="btn btn-secondary" onclick="showPreviewSide('back')" style="padding: 10px 20px;">
                    Back Side
                </button>
            </div>
            
            <div style="text-align: center; overflow: auto; max-height: 70vh;">
                <div id="previewContainer" style="display: inline-block; border: 3px solid #667eea; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <img id="previewImage" src="" alt="Badge Preview" style="display: block; max-width: 100%; height: auto;">
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    üìê <strong>Actual Print Size:</strong> CR80 (3.375" √ó 2.125") at 300 DPI
                </p>
                <button class="btn btn-secondary" onclick="closePreview()" style="padding: 12px 30px;">
                    Close Preview
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        
        const BADGE_WIDTH = 1012;
        const BADGE_HEIGHT = 638;
        const SCALE = 0.45;

        let canvas;
        let frontDesign = null;
        let backDesign = null;
        let currentSide = 'front';
        let excelData = null;
        let backgroundImage = null;
        let slotObject = null; // Track the lanyard slot visual
        let magneticStripeObject = null; // Track the magnetic stripe visual
        let doubleSidedUpcharge = 0; // Track double-sided upcharge
        let magneticStripeUpcharge = 0; // Track magnetic stripe upcharge
        let hasDesignContent = false; // Track if canvas has user content

        // Cloudinary config for direct uploads
        const CLOUDINARY_CLOUD_NAME = 'dbx6y5l2d';
        const CLOUDINARY_UPLOAD_PRESET = 'ml_default'; // unsigned preset

        // Pre-designed templates
        const templates = {
            corporate: {
                name: 'Corporate Blue',
                category: 'company',
                bgColor: '#2196F3',
                accentColor: '#1976D2'
            },
            medical: {
                name: 'Medical Green',
                category: 'medical',
                bgColor: '#4CAF50',
                accentColor: '#388E3C'
            },
            education: {
                name: 'Education Red',
                category: 'university',
                bgColor: '#f44336',
                accentColor: '#d32f2f'
            },
            security: {
                name: 'Security Black',
                category: 'security',
                bgColor: '#212121',
                accentColor: '#424242'
            },
            event: {
                name: 'Event Purple',
                category: 'event',
                bgColor: '#9C27B0',
                accentColor: '#7B1FA2'
            },
            minimal: {
                name: 'Minimal White',
                category: 'company',
                bgColor: '#ffffff',
                accentColor: '#e0e0e0'
            },
            conference1: {
                name: 'Conference Blue',
                category: 'conference',
                bgColor: '#1565C0',
                accentColor: '#0D47A1'
            },
            conference2: {
                name: 'Conference Orange',
                category: 'conference',
                bgColor: '#FF6F00',
                accentColor: '#E65100'
            },
            university1: {
                name: 'University Navy',
                category: 'university',
                bgColor: '#1A237E',
                accentColor: '#0D47A1'
            },
            company2: {
                name: 'Company Teal',
                category: 'company',
                bgColor: '#00695C',
                accentColor: '#004D40'
            }
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.onload = function() {
            canvas = new fabric.Canvas('canvas', {
                width: BADGE_WIDTH * SCALE,
                height: BADGE_HEIGHT * SCALE,
                backgroundColor: '#ffffff'
            });

            canvas.on('selection:created', handleSelection);
            canvas.on('selection:updated', handleSelection);
            canvas.on('selection:cleared', handleDeselection);
            
            // Check canvas content when objects are added or removed
            canvas.on('object:added', function() {
                setTimeout(checkCanvasContent, 100);
            });
            canvas.on('object:removed', function() {
                setTimeout(checkCanvasContent, 100);
            });

            // Prevent magnetic stripe from being selected
            canvas.on('before:selection:cleared', function(e) {
                if (e.target && e.target === magneticStripeObject) {
                    return false;
                }
            });

            canvas.on('mouse:down', function(e) {
                if (e.target && e.target === magneticStripeObject) {
                    canvas.discardActiveObject();
                    canvas.renderAll();
                    return false;
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    // Check if user is typing in an input field or textarea
                    const activeElement = document.activeElement;
                    const isInputField = activeElement && (
                        activeElement.tagName === 'INPUT' || 
                        activeElement.tagName === 'TEXTAREA' ||
                        activeElement.isContentEditable
                    );
                    
                    // If typing in an input field, allow normal backspace/delete behavior
                    if (isInputField) {
                        return; // Let default behavior happen
                    }
                    
                    const obj = canvas.getActiveObject();
                    
                    // Check if it's a text object being edited on canvas
                    if (obj && (obj.type === 'i-text' || obj.type === 'text')) {
                        // If text is in editing mode, don't delete the object
                        if (obj.isEditing) {
                            return; // Let the default text editing behavior happen
                        }
                    }
                    
                    // For non-text objects or selected (but not editing) text, delete the element
                    deleteSelectedElement();
                    e.preventDefault(); // Prevent default behavior
                }
            });

            loadTemplateGallery();
            
            // Set initial magnetic option visibility based on badge style
            updateMagneticOptionVisibility();
            
            // Apply magnetic stripe restrictions on load
            enforceMagneticStripeRestrictions();
            
            // Set minimum delivery date (3 business days from today)
            const today = new Date();
            const minDate = new Date(today);
            let daysAdded = 0;
            while (daysAdded < 3) {
                minDate.setDate(minDate.getDate() + 1);
                if (minDate.getDay() !== 0 && minDate.getDay() !== 6) {
                    daysAdded++;
                }
            }
            
            const deliveryDateInput = document.getElementById('deliveryDate');
            if (deliveryDateInput) {
                const minDateStr = minDate.toISOString().split('T')[0];
                deliveryDateInput.min = minDateStr;
            }
            
            toast('‚úÖ Designer Ready!');
        };

        // ============================================
        // BADGE STYLE & SLOT VISUAL
        // ============================================
        
        function updateBadgeStyle() {
            const style = document.getElementById('badgeStyle').value;
            const backTab = document.getElementById('backTab');
            const note = document.getElementById('doubleSidedNote');
            const cardTypeDropdown = document.getElementById('cardType');
            const magneticOption = document.getElementById('magneticOption');
            
            if (style === 'single') {
                // Single sided - disable back tab
                backTab.classList.add('disabled');
                backTab.style.pointerEvents = 'none';
                doubleSidedUpcharge = 0;
                note.style.display = 'none';
                
                // Hide magnetic stripe option (not applicable for single-sided)
                if (magneticOption) {
                    magneticOption.style.display = 'none';
                }
                
                // If magnetic stripe is currently selected, switch to standard
                if (cardTypeDropdown.value === 'magnetic') {
                    cardTypeDropdown.value = 'standard';
                    updateMagneticStripeVisual();
                }
                
                // If currently on back side, switch to front
                if (currentSide === 'back') {
                    switchToFront();
                }
                
                toast('üìÑ Single sided selected');
            } else {
                // Double sided - enable back tab
                backTab.classList.remove('disabled');
                backTab.style.pointerEvents = 'auto';
                doubleSidedUpcharge = 1.00;
                note.style.display = 'block';
                
                // Show magnetic stripe option (available for double-sided)
                if (magneticOption) {
                    magneticOption.style.display = 'block';
                }
                
                toast('üìÑüìÑ Double sided selected (+$1.00)');
            }
            
            // Update magnetic stripe visual if needed
            updateMagneticStripeVisual();
            
            // Enforce magnetic stripe restrictions (orientation & slot)
            enforceMagneticStripeRestrictions();
            
            // Update pricing
            updatePriceByType();
        }

        function updateMagneticOptionVisibility() {
            const style = document.getElementById('badgeStyle').value;
            const magneticOption = document.getElementById('magneticOption');
            
            if (style === 'single') {
                // Hide magnetic stripe option for single-sided
                if (magneticOption) {
                    magneticOption.style.display = 'none';
                }
            } else {
                // Show magnetic stripe option for double-sided
                if (magneticOption) {
                    magneticOption.style.display = 'block';
                }
            }
        }

        function updateSlotVisual() {
            const slotType = document.getElementById('holeSlot').value;
            const orientation = document.getElementById('orientation').value;
            
            // ALWAYS remove existing slot first
            if (slotObject) {
                canvas.remove(slotObject);
                slotObject = null;
                canvas.renderAll();
            }
            
            // Only create new slot if "lanyard" is selected
            if (slotType === 'lanyard') {
                // Create lanyard slot visual
                // Based on images: slot is approximately 15mm (0.59") wide x 4mm (0.16") tall
                
                let slotWidth, slotHeight, slotX, slotY, canvasWidth, canvasHeight;
                
                if (orientation === 'portrait') {
                    // Portrait: canvas is rotated, use HEIGHT for width calculation
                    canvasWidth = BADGE_HEIGHT * SCALE;
                    canvasHeight = BADGE_WIDTH * SCALE;
                } else {
                    // Landscape: normal dimensions
                    canvasWidth = BADGE_WIDTH * SCALE;
                    canvasHeight = BADGE_HEIGHT * SCALE;
                }
                
                // Slot dimensions (same for both orientations)
                slotWidth = 80 * SCALE;   // Wider slot (about 15mm)
                slotHeight = 18 * SCALE;  // Taller for visibility (about 4mm)
                
                // Center horizontally based on actual canvas width
                slotX = (canvasWidth / 2) - (slotWidth / 2);
                slotY = 15 * SCALE;  // Fixed distance from top
                
                slotObject = new fabric.Rect({
                    left: slotX,
                    top: slotY,
                    width: slotWidth,
                    height: slotHeight,
                    fill: '#e8e8e8',  // Lighter gray
                    stroke: '#666666',  // Darker border
                    strokeWidth: 2,
                    rx: 9 * SCALE,  // Rounded corners
                    ry: 9 * SCALE,
                    selectable: false,
                    evented: false,
                    lockMovementX: true,
                    lockMovementY: true,
                    hasControls: false,
                    hasBorders: false
                });
                
                canvas.add(slotObject);
                canvas.bringToFront(slotObject); // Always on top
                canvas.renderAll();
                
                toast('‚úÖ Standard Oval Hole added to badge');
            } else {
                // Slot removed
                toast('‚úÖ Hole removed');
            }
        }

        // ============================================
        // MAGNETIC STRIPE VISUAL
        // ============================================
        
        function updateMagneticStripeVisual() {
            const cardType = document.getElementById('cardType').value;
            const badgeStyle = document.getElementById('badgeStyle').value;
            const orientation = document.getElementById('orientation').value;
            
            // ALWAYS remove existing magnetic stripe first
            if (magneticStripeObject) {
                canvas.remove(magneticStripeObject);
                magneticStripeObject = null;
            }
            
            // Only show magnetic stripe if:
            // 1. Card type is magnetic
            // 2. Style is double-sided
            // 3. Currently on back side
            if (cardType === 'magnetic' && badgeStyle === 'double' && currentSide === 'back') {
                let stripeWidth, stripeHeight, stripeX, stripeY, canvasWidth;
                
                if (orientation === 'portrait') {
                    // Portrait: canvas is rotated
                    canvasWidth = BADGE_HEIGHT * SCALE;
                } else {
                    // Landscape: normal dimensions
                    canvasWidth = BADGE_WIDTH * SCALE;
                }
                
                // Magnetic stripe dimensions
                // Full width, taller height to match reference image (about 0.8" or 130px)
                // 40px gap from top for proper alignment
                stripeWidth = canvasWidth;
                stripeHeight = 130 * SCALE;  // Increased to 130px for proper alignment with reference
                stripeX = 0;
                stripeY = 40 * SCALE;  // 40px gap from top edge
                
                magneticStripeObject = new fabric.Rect({
                    left: stripeX,
                    top: stripeY,
                    width: stripeWidth,
                    height: stripeHeight,
                    fill: '#000000',  // Black for magnetic stripe
                    stroke: null,
                    strokeWidth: 0,
                    selectable: false,      // Cannot be selected
                    evented: false,         // Cannot receive events
                    lockMovementX: true,    // Lock horizontal movement
                    lockMovementY: true,    // Lock vertical movement
                    lockScalingX: true,     // Lock horizontal scaling
                    lockScalingY: true,     // Lock vertical scaling
                    lockRotation: true,     // Lock rotation
                    lockSkewingX: true,     // Lock skewing X
                    lockSkewingY: true,     // Lock skewing Y
                    hasControls: false,     // No controls
                    hasBorders: false,      // No borders
                    hoverCursor: 'default', // Normal cursor
                    moveCursor: 'default'   // Normal cursor
                });
                
                canvas.add(magneticStripeObject);
                canvas.sendToBack(magneticStripeObject); // Behind other elements but above background
                
                // If there's a background image, make sure stripe is above it
                if (backgroundImage) {
                    canvas.sendToBack(backgroundImage);
                }
            }
            
            // ALWAYS render canvas after any changes (add or remove)
            canvas.renderAll();
        }

        // ============================================
        // MAGNETIC STRIPE RESTRICTIONS
        // ============================================
        
        function enforceMagneticStripeRestrictions() {
            const cardType = document.getElementById('cardType').value;
            const badgeStyle = document.getElementById('badgeStyle').value;
            const holeSlotDropdown = document.getElementById('holeSlot');
            const orientationDropdown = document.getElementById('orientation');
            
            // Check if magnetic card with double-sided printing
            if (cardType === 'magnetic' && badgeStyle === 'double') {
                // Force No Slot
                holeSlotDropdown.value = 'none';
                holeSlotDropdown.disabled = true;
                holeSlotDropdown.style.opacity = '0.5';
                holeSlotDropdown.style.cursor = 'not-allowed';
                
                // Force Landscape orientation
                orientationDropdown.value = 'landscape';
                orientationDropdown.disabled = true;
                orientationDropdown.style.opacity = '0.5';
                orientationDropdown.style.cursor = 'not-allowed';
                
                // Update visuals to match forced settings
                updateSlotVisual(); // Remove slot if present
                
                // Change to landscape if currently portrait
                if (canvas.width !== BADGE_WIDTH * SCALE) {
                    changeOrientation();
                }
                
            } else {
                // Enable both dropdowns
                holeSlotDropdown.disabled = false;
                holeSlotDropdown.style.opacity = '1';
                holeSlotDropdown.style.cursor = 'pointer';
                
                orientationDropdown.disabled = false;
                orientationDropdown.style.opacity = '1';
                orientationDropdown.style.cursor = 'pointer';
            }
        }

        // ============================================
        // BACKGROUND IMAGE
        // ============================================
        
        function handleBackgroundUpload(event) {
            // Prevent background uploads on back side
            if (currentSide === 'back') {
                toast('‚ö†Ô∏è Background images not available on back side (black printing only)');
                event.target.value = ''; // Reset file input
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                toast('‚ùå Background image too large (max 10MB)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                fabric.Image.fromURL(e.target.result, function(img) {
                    // Remove existing background if present
                    if (backgroundImage) {
                        canvas.remove(backgroundImage);
                        backgroundImage = null;
                    }

                    // Scale to fit canvas exactly
                    const scaleX = (BADGE_WIDTH * SCALE) / img.width;
                    const scaleY = (BADGE_HEIGHT * SCALE) / img.height;
                    
                    img.set({
                        left: 0,
                        top: 0,
                        scaleX: scaleX,
                        scaleY: scaleY,
                        selectable: false,  // Cannot be selected/moved
                        evented: false,     // Cannot be clicked
                        lockMovementX: true,
                        lockMovementY: true,
                        lockScalingX: true,
                        lockScalingY: true,
                        lockRotation: true,
                        hasControls: false,
                        hasBorders: false,
                        isBackground: true  // Custom property to identify background
                    });

                    backgroundImage = img;
                    canvas.add(img);
                    canvas.sendToBack(img);  // Always at bottom
                    canvas.renderAll();
                    
                    // Update checkout button state
                    checkCanvasContent();

                    toast('‚úÖ Background image added!');
                });
            };
            reader.readAsDataURL(file);
            
            // Reset input so same file can be re-selected
            event.target.value = '';
        }
        
        // Ensure background stays at back after any canvas operation
        function ensureBackgroundAtBack() {
            if (backgroundImage && canvas.getObjects().indexOf(backgroundImage) !== -1) {
                canvas.sendToBack(backgroundImage);
                // Make sure slot and magnetic stripe stay on top of background
                if (slotObject) {
                    canvas.bringToFront(slotObject);
                }
                if (magneticStripeObject) {
                    canvas.bringToFront(magneticStripeObject);
                }
                canvas.renderAll();
            }
        }

        function removeBackground() {
            if (backgroundImage) {
                canvas.remove(backgroundImage);
                backgroundImage = null;
                canvas.renderAll();
                checkCanvasContent();
                toast('‚úÖ Background removed');
            } else {
                toast('‚ö†Ô∏è No background to remove');
            }
        }

        // ============================================
        // TEMPLATE GALLERY
        // ============================================
        
        // Store Cloudinary templates
        let cloudinaryTemplates = [];
        let cloudinaryCategories = [];
        let isLoadingTemplates = false;
        
        async function loadTemplateGallery() {
            const grid = document.getElementById('templateGrid');
            const categorySelect = document.getElementById('templateCategory');
            
            // Show loading state
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #666;">
                    <div style="font-size: 50px; margin-bottom: 20px;">‚è≥</div>
                    <p style="font-size: 16px;">Loading templates from gallery...</p>
                </div>
            `;
            
            // Load Cloudinary templates
            if (!isLoadingTemplates) {
                isLoadingTemplates = true;
                try {
                    console.log('Fetching templates from API...');
                    const response = await fetch('/api/get-templates');
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    if (response.ok && data.success) {
                        cloudinaryTemplates = data.templates || [];
                        cloudinaryCategories = data.categories || [];
                        
                        console.log(`Found ${cloudinaryTemplates.length} templates`);
                        console.log(`Found ${cloudinaryCategories.length} categories`);
                        
                        // Update category dropdown with Cloudinary categories
                        categorySelect.innerHTML = '<option value="all">All Categories</option>';
                        cloudinaryCategories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.name;
                            option.textContent = cat.display;
                            categorySelect.appendChild(option);
                        });
                        
                        // Display templates
                        displayCloudinaryTemplates(grid, cloudinaryTemplates);
                        
                        // Show message if no templates found
                        if (cloudinaryTemplates.length === 0 && data.message) {
                            grid.innerHTML = `
                                <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #666;">
                                    <div style="font-size: 50px; margin-bottom: 20px;">üìÅ</div>
                                    <p style="font-size: 16px;">${data.message}</p>
                                    <p style="font-size: 13px; color: #888; margin-top: 10px;">Make sure you have templates uploaded to Cloudinary in the correct folder structure.</p>
                                </div>
                            `;
                        }
                    } else {
                        const errorMsg = data.details || data.error || 'Unknown error';
                        console.error('API Error:', errorMsg);
                        grid.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #dc3545;">
                                <div style="font-size: 50px; margin-bottom: 20px;">‚ùå</div>
                                <p style="font-size: 16px;">Failed to load templates</p>
                                <p style="font-size: 13px; color: #666; margin-top: 10px;">${errorMsg}</p>
                                <button onclick="loadTemplateGallery()" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    üîÑ Retry
                                </button>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading Cloudinary templates:', error);
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #dc3545;">
                            <div style="font-size: 50px; margin-bottom: 20px;">‚ùå</div>
                            <p style="font-size: 16px;">Error loading templates</p>
                            <p style="font-size: 13px; color: #666; margin-top: 10px;">${error.message}</p>
                            <button onclick="loadTemplateGallery()" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                üîÑ Retry
                            </button>
                        </div>
                    `;
                }
                isLoadingTemplates = false;
            }
        }
        
        function displayCloudinaryTemplates(grid, templates) {
            grid.innerHTML = '';
            
            if (templates.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 50px; margin-bottom: 20px;">üìÅ</div>
                        <p style="font-size: 16px;">No templates found in gallery.</p>
                    </div>
                `;
                return;
            }
            
            templates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.dataset.category = template.category;
                card.dataset.name = template.name.toLowerCase();
                card.onclick = () => applyCloudinaryTemplate(template);
                
                card.innerHTML = `
                    <div class="template-preview" style="background: #f8f9fa; overflow: hidden; border: 2px solid #e0e0e0;">
                        ${template.preview ? 
                            `<img src="${template.preview}" alt="${template.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                            (template.front ?
                                `<img src="${template.front}" alt="${template.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                `<span style="color: #666; font-weight: 600;">No Preview</span>`)
                        }
                    </div>
                    <div class="template-name">${template.name}</div>
                    <div style="font-size: 11px; color: #667eea; text-transform: capitalize;">üìÅ ${template.categoryDisplay}</div>
                    ${template.back ? '<div style="font-size: 10px; color: #28a745;">‚úì Front & Back</div>' : '<div style="font-size: 10px; color: #888;">Front Only</div>'}
                `;
                
                grid.appendChild(card);
            });
        }
        
        function filterTemplates() {
            const searchValue = document.getElementById('templateSearch').value.toLowerCase();
            const categoryValue = document.getElementById('templateCategory').value;
            const cards = document.querySelectorAll('.template-card');
            
            let visibleCount = 0;
            cards.forEach(card => {
                const matchesSearch = card.dataset.name.includes(searchValue);
                const matchesCategory = categoryValue === 'all' || card.dataset.category === categoryValue;
                
                if (matchesSearch && matchesCategory) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show message if no results
            const grid = document.getElementById('templateGrid');
            const noResultsMsg = document.getElementById('noResultsMsg');
            if (visibleCount === 0 && cards.length > 0) {
                if (!noResultsMsg) {
                    const msg = document.createElement('div');
                    msg.id = 'noResultsMsg';
                    msg.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 40px; color: #666;';
                    msg.innerHTML = '<p>No templates match your search.</p>';
                    grid.appendChild(msg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }

        function openTemplateGallery() {
            document.getElementById('templateModal').classList.add('show');
            // Reset search and filter
            document.getElementById('templateSearch').value = '';
            document.getElementById('templateCategory').value = 'all';
            loadTemplateGallery(); // Load/refresh templates when opened
        }

        function closeTemplateGallery() {
            document.getElementById('templateModal').classList.remove('show');
        }
        
        // Apply Cloudinary template (loads image as background)
        async function applyCloudinaryTemplate(template) {
            closeTemplateGallery();
            toast('‚è≥ Loading template...');
            
            // Clear current canvas
            canvas.clear();
            canvas.backgroundColor = '#ffffff';
            backgroundImage = null;
            slotObject = null;
            magneticStripeObject = null;
            
            // Make sure we're on front side
            if (currentSide !== 'front') {
                currentSide = 'front';
                updateTabs();
            }
            
            // Load front image as background
            if (template.front) {
                try {
                    await loadImageAsBackground(template.front);
                    
                    // Save front design
                    saveCurrentSide();
                    
                    // If back image exists, load it too (regardless of badge style setting)
                    if (template.back) {
                        // Auto-enable double-sided if template has back
                        document.getElementById('badgeStyle').value = 'double';
                        updateBadgeStyle();
                        
                        // Switch to back side
                        currentSide = 'back';
                        canvas.clear();
                        canvas.backgroundColor = '#ffffff';
                        backgroundImage = null;
                        
                        await loadImageAsBackground(template.back);
                        saveCurrentSide();
                        
                        // Switch back to front
                        currentSide = 'front';
                        loadSide('front');
                        updateTabs();
                        
                        toast(`‚úÖ Applied "${template.name}" template (Front & Back)!`);
                    } else {
                        toast(`‚úÖ Applied "${template.name}" template!`);
                    }
                    
                    checkCanvasContent();
                } catch (error) {
                    console.error('Error loading template:', error);
                    toast('‚ùå Failed to load template');
                }
            } else {
                toast('‚ö†Ô∏è Template has no front image');
            }
            
            // Restore slot visual
            updateSlotVisual();
            canvas.renderAll();
        }
        
        // Helper function to load image as background
        function loadImageAsBackground(imageUrl) {
            return new Promise((resolve, reject) => {
                fabric.Image.fromURL(imageUrl, function(img) {
                    if (!img) {
                        reject(new Error('Failed to load image'));
                        return;
                    }
                    
                    // Remove existing background if present
                    if (backgroundImage) {
                        canvas.remove(backgroundImage);
                    }
                    
                    // Get current canvas dimensions
                    const canvasWidth = canvas.getWidth();
                    const canvasHeight = canvas.getHeight();
                    
                    // Scale to fit canvas exactly
                    const scaleX = canvasWidth / img.width;
                    const scaleY = canvasHeight / img.height;
                    
                    img.set({
                        left: 0,
                        top: 0,
                        scaleX: scaleX,
                        scaleY: scaleY,
                        selectable: false,
                        evented: false,
                        lockMovementX: true,
                        lockMovementY: true,
                        lockScalingX: true,
                        lockScalingY: true,
                        lockRotation: true,
                        hasControls: false,
                        hasBorders: false,
                        isBackground: true
                    });
                    
                    backgroundImage = img;
                    canvas.add(img);
                    canvas.sendToBack(img);
                    canvas.renderAll();
                    
                    resolve(img);
                }, { crossOrigin: 'anonymous' });
            });
        }

        // Legacy function for compatibility
        function applyTemplate(templateKey) {
            // No longer used - kept for compatibility
            toast('‚ö†Ô∏è Please select a template from the gallery');
        }

        // ============================================
        // ADD ELEMENTS
        // ============================================
        
        function addTextElement() {
            // Use black color for back side, default for front side
            const textColor = currentSide === 'back' ? '#000000' : '#000000';
            
            const text = new fabric.IText('Double-click to edit', {
                left: 100 * SCALE,
                top: 150 * SCALE,
                fontSize: 28 * SCALE,
                fill: textColor,
                fontFamily: 'Arial',
                fontWeight: 'bold'
            });

            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.renderAll();
            
            if (currentSide === 'back') {
                toast('‚úÖ Text added! (Black only on back side)');
            } else {
                toast('‚úÖ Text added!');
            }
        }

        function addRectangleElement() {
            // Use black color for back side, default purple for front side
            const fillColor = currentSide === 'back' ? '#000000' : '#667eea';
            
            const rect = new fabric.Rect({
                left: 150 * SCALE,
                top: 150 * SCALE,
                width: 180 * SCALE,
                height: 120 * SCALE,
                fill: fillColor,
                stroke: null,
                strokeWidth: 0
            });

            canvas.add(rect);
            canvas.setActiveObject(rect);
            canvas.renderAll();
            
            if (currentSide === 'back') {
                toast('‚úÖ Rectangle added! (Black only on back side)');
            } else {
                toast('‚úÖ Rectangle added!');
            }
        }

        function addCircleElement() {
            // Use black color for back side, default green for front side
            const fillColor = currentSide === 'back' ? '#000000' : '#28a745';
            
            const circle = new fabric.Circle({
                left: 150 * SCALE,
                top: 150 * SCALE,
                radius: 60 * SCALE,
                fill: fillColor,
                stroke: null,
                strokeWidth: 0
            });

            canvas.add(circle);
            canvas.setActiveObject(circle);
            canvas.renderAll();
            
            if (currentSide === 'back') {
                toast('‚úÖ Circle added! (Black only on back side)');
            } else {
                toast('‚úÖ Circle added!');
            }
        }

        // ============================================
        // REAL BARCODE GENERATION (Using JsBarcode)
        // ============================================
        
        function openBarcodeDialog() {
            document.getElementById('barcodeModal').classList.add('show');
            document.getElementById('barcodeValue').value = '';
        }

        function closeBarcodeDialog() {
            document.getElementById('barcodeModal').classList.remove('show');
        }

        function addBarcodeWithValue() {
            const type = document.getElementById('barcodeType').value;
            const value = document.getElementById('barcodeValue').value.trim();

            if (!value) {
                toast('‚ö†Ô∏è Please enter a barcode value');
                return;
            }

            // Validate UPC-A
            if (type === 'UPCA' && (value.length !== 12 && value.length !== 11) || (type === 'UPCA' && !/^\d+$/.test(value))) {
                toast('‚ö†Ô∏è UPC-A requires 11 or 12 digits');
                return;
            }

            try {
                // Create temporary canvas for barcode generation
                const tempCanvas = document.createElement('canvas');
                
                // Generate barcode using JsBarcode
                JsBarcode(tempCanvas, value, {
                    format: type === 'Code39' ? 'CODE39' : type === 'Code128' ? 'CODE128' : 'UPC',
                    width: 2,
                    height: 80,
                    displayValue: true,
                    fontSize: 14,
                    margin: 10
                });

                // Convert canvas to data URL
                const barcodeDataUrl = tempCanvas.toDataURL('image/png');

                // Add to Fabric canvas
                fabric.Image.fromURL(barcodeDataUrl, function(img) {
                    img.scaleToWidth(220 * SCALE);
                    
                    img.set({
                        left: 120 * SCALE,
                        top: 180 * SCALE
                    });

                    canvas.add(img);
                    canvas.setActiveObject(img);
                    canvas.renderAll();

                    // Auto-add barcode field with TYPE
                    addAutoField(`Barcode | ${type}`, value);

                    closeBarcodeDialog();
                    toast(`‚úÖ Real ${type} barcode added!`);
                });
            } catch (error) {
                console.error('Barcode generation error:', error);
                toast('‚ùå Error generating barcode. Please check the value.');
            }
        }

        // ============================================
        // REAL QR CODE GENERATION (Using qrcode-generator)
        // ============================================
        
        function openQRCodeDialog() {
            document.getElementById('qrcodeModal').classList.add('show');
            document.getElementById('qrcodeValue').value = '';
        }

        function closeQRCodeDialog() {
            document.getElementById('qrcodeModal').classList.remove('show');
        }

        // ============================================
        // CARD SIZE INFO MODAL
        // ============================================
        
        function openCardSizeInfo() {
            document.getElementById('cardSizeModal').classList.add('show');
        }

        function closeCardSizeInfo() {
            document.getElementById('cardSizeModal').classList.remove('show');
        }

        // ============================================
        // ARTWORK UPLOAD MODAL
        // ============================================
        
        function openArtworkUpload() {
            document.getElementById('artworkModal').classList.add('show');
        }

        function closeArtworkUpload() {
            document.getElementById('artworkModal').classList.remove('show');
            // Reset file input and count
            document.getElementById('artworkFiles').value = '';
            document.getElementById('artworkUploadCount').innerHTML = '';
        }

        function toggleAccordion(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + '-icon');
            
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                section.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function handleArtworkFilesSelected() {
            const input = document.getElementById('artworkFiles');
            const files = input.files;
            const countDisplay = document.getElementById('artworkUploadCount');
            
            if (files.length > 0) {
                // Show upload count
                countDisplay.innerHTML = `‚úÖ Uploaded ${files.length} image${files.length > 1 ? 's' : ''}`;
                
                // Store file data for Cloudinary upload
                window.artworkUploaded = true;
                window.artworkFileNames = Array.from(files).map(f => f.name);
                window.artworkFilesData = [];
                
                // Convert files to base64 for upload
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        window.artworkFilesData.push({
                            name: file.name,
                            data: e.target.result
                        });
                    };
                    reader.readAsDataURL(file);
                });
                
                // Show success toast
                toast(`‚úÖ ${files.length} artwork file(s) selected successfully!`);
            } else {
                countDisplay.innerHTML = '';
                window.artworkUploaded = false;
                window.artworkFileNames = [];
                window.artworkFilesData = [];
            }
        }

        // ============================================
        // DELIVERY DATE VALIDATION
        // ============================================
        
        function validateDeliveryDate() {
            const dateInput = document.getElementById('deliveryDate');
            const selectedDate = new Date(dateInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day
            
            // Calculate minimum date (today + 3 business days)
            const minDate = new Date(today);
            let daysAdded = 0;
            while (daysAdded < 3) {
                minDate.setDate(minDate.getDate() + 1);
                // Skip weekends
                if (minDate.getDay() !== 0 && minDate.getDay() !== 6) {
                    daysAdded++;
                }
            }
            
            // Calculate maximum date (today + 7 business days)
            const maxDate = new Date(today);
            daysAdded = 0;
            while (daysAdded < 7) {
                maxDate.setDate(maxDate.getDate() + 1);
                if (maxDate.getDay() !== 0 && maxDate.getDay() !== 6) {
                    daysAdded++;
                }
            }
            
            if (selectedDate < minDate) {
                toast('‚ö†Ô∏è Delivery date must be at least 3 business days from today');
                dateInput.value = '';
                return false;
            }
            
            toast('‚úÖ Delivery date confirmed');
            return true;
        }

        function addQRCodeWithValue() {
            const value = document.getElementById('qrcodeValue').value.trim();

            if (!value) {
                toast('‚ö†Ô∏è Please enter QR code data');
                return;
            }

            try {
                // Create QR code using qrcode-generator library
                const qr = qrcode(0, 'M'); // 0 = auto-detect version, 'M' = medium error correction
                qr.addData(value);
                qr.make();

                // Create a temporary canvas to draw QR code
                const cellSize = 8; // Size of each QR cell in pixels
                const margin = cellSize * 2; // Margin around QR code
                const moduleCount = qr.getModuleCount();
                const canvasSize = moduleCount * cellSize + margin * 2;

                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvasSize;
                tempCanvas.height = canvasSize;
                const ctx = tempCanvas.getContext('2d');

                // White background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvasSize, canvasSize);

                // Draw QR code
                ctx.fillStyle = '#000000';
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(
                                col * cellSize + margin,
                                row * cellSize + margin,
                                cellSize,
                                cellSize
                            );
                        }
                    }
                }

                // Convert canvas to data URL
                const qrcodeDataUrl = tempCanvas.toDataURL('image/png');

                // Add to Fabric canvas
                fabric.Image.fromURL(qrcodeDataUrl, function(img) {
                    img.scaleToWidth(110 * SCALE);
                    
                    img.set({
                        left: 180 * SCALE,
                        top: 150 * SCALE
                    });

                    canvas.add(img);
                    canvas.setActiveObject(img);
                    canvas.renderAll();

                    // Auto-add QR Code field
                    addAutoField('QR Code Data', value);

                    closeQRCodeDialog();
                    toast('‚úÖ Real QR Code added!');
                });
            } catch (error) {
                console.error('QR Code generation error:', error);
                toast('‚ùå Error generating QR code. Please check the data.');
            }
        }

        function handleImageUpload(event) {
            // Prevent photo uploads on back side
            if (currentSide === 'back') {
                toast('‚ö†Ô∏è Photos not available on back side (black printing only)');
                event.target.value = ''; // Reset file input
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                toast('‚ùå Image too large (max 5MB)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                fabric.Image.fromURL(e.target.result, function(img) {
                    img.scaleToWidth(220 * SCALE);
                    img.set({
                        left: 120 * SCALE,
                        top: 120 * SCALE
                    });

                    canvas.add(img);
                    canvas.setActiveObject(img);
                    canvas.renderAll();
                    toast('‚úÖ Image added!');
                });
            };
            reader.readAsDataURL(file);
        }

        // ============================================
        // TEXT FORMATTING
        // ============================================
        
        function handleSelection(e) {
            const obj = e.selected[0];
            
            if (obj && (obj.type === 'i-text' || obj.type === 'text')) {
                // Show text controls
                document.getElementById('textControls').classList.add('show');
                document.getElementById('shapeControls').classList.remove('show');
                
                document.getElementById('fontFamily').value = obj.fontFamily;
                document.getElementById('fontSize').value = Math.round(obj.fontSize / SCALE);
                document.getElementById('textColor').value = obj.fill;
                document.getElementById('fontWeight').value = obj.fontWeight;
            } else if (obj && (obj.type === 'rect' || obj.type === 'circle')) {
                // Show shape controls
                document.getElementById('textControls').classList.remove('show');
                document.getElementById('shapeControls').classList.add('show');
                
                document.getElementById('shapeFillColor').value = obj.fill;
            } else {
                // Hide all controls
                document.getElementById('textControls').classList.remove('show');
                document.getElementById('shapeControls').classList.remove('show');
            }
        }

        function handleDeselection() {
            document.getElementById('textControls').classList.remove('show');
            document.getElementById('shapeControls').classList.remove('show');
        }

        function updateTextFormat() {
            const obj = canvas.getActiveObject();
            if (!obj || (obj.type !== 'i-text' && obj.type !== 'text')) return;

            // Force black color on back side
            let textColor = document.getElementById('textColor').value;
            if (currentSide === 'back') {
                textColor = '#000000';
                document.getElementById('textColor').value = '#000000';
            }

            obj.set({
                fontFamily: document.getElementById('fontFamily').value,
                fontSize: parseInt(document.getElementById('fontSize').value) * SCALE,
                fill: textColor,
                fontWeight: document.getElementById('fontWeight').value
            });
            canvas.renderAll();
        }

        function updateShapeColor() {
            const obj = canvas.getActiveObject();
            if (!obj || (obj.type !== 'rect' && obj.type !== 'circle')) return;

            // Force black color on back side
            let shapeColor = document.getElementById('shapeFillColor').value;
            if (currentSide === 'back') {
                shapeColor = '#000000';
                document.getElementById('shapeFillColor').value = '#000000';
            }

            obj.set({
                fill: shapeColor
            });
            canvas.renderAll();
        }

        // ============================================
        // LAYER CONTROLS
        // ============================================
        
        function bringToFront() {
            const obj = canvas.getActiveObject();
            if (obj) {
                canvas.bringToFront(obj);
                canvas.renderAll();
                toast('‚úÖ Brought to front');
            }
        }

        function sendToBack() {
            const obj = canvas.getActiveObject();
            if (obj) {
                canvas.sendToBack(obj);
                // Make sure background stays at bottom
                if (backgroundImage) {
                    canvas.sendToBack(backgroundImage);
                }
                canvas.renderAll();
                toast('‚úÖ Sent to back');
            }
        }

        // ============================================
        // CUSTOM FIELDS
        // ============================================
        
        function addCustomField() {
            const fieldHtml = `
                <div class="custom-field-item">
                    <div class="custom-field-row">
                        <input type="text" class="custom-field-input field-label" placeholder="Field Label">
                        <input type="text" class="custom-field-input field-value" placeholder="Field Value">
                        <button class="btn-remove" onclick="removeField(this)">√ó</button>
                    </div>
                </div>
            `;
            
            document.getElementById('customFieldsList').insertAdjacentHTML('beforeend', fieldHtml);
            toast('‚úÖ New field added!');
        }

        function removeField(button) {
            button.closest('.custom-field-item').remove();
            toast('‚úÖ Field removed');
        }

        function addAutoField(label, value) {
            const fieldHtml = `
                <div class="custom-field-item">
                    <div class="custom-field-row">
                        <input type="text" class="custom-field-input field-label" value="${label}" readonly>
                        <input type="text" class="custom-field-input field-value" value="${value}">
                        <button class="btn-remove" onclick="removeField(this)">√ó</button>
                    </div>
                </div>
            `;
            
            document.getElementById('customFieldsList').insertAdjacentHTML('beforeend', fieldHtml);
        }

        function addAllFieldsToBadge() {
            const fields = document.querySelectorAll('.custom-field-item');
            let addedCount = 0;
            let yPosition = 80 * SCALE;

            fields.forEach((fieldItem) => {
                const label = fieldItem.querySelector('.field-label').value.trim();
                const value = fieldItem.querySelector('.field-value').value.trim();

                if (label && value) {
                    const labelText = new fabric.Text(label + ':', {
                        left: 25 * SCALE,
                        top: yPosition,
                        fontSize: 14 * SCALE,
                        fill: '#666666',
                        fontFamily: 'Arial',
                        fontWeight: 'normal'
                    });
                    canvas.add(labelText);
                    yPosition += 20 * SCALE;

                    const valueText = new fabric.Text(value, {
                        left: 25 * SCALE,
                        top: yPosition,
                        fontSize: 22 * SCALE,
                        fill: '#000000',
                        fontFamily: 'Arial',
                        fontWeight: 'bold'
                    });
                    canvas.add(valueText);
                    yPosition += 35 * SCALE;

                    addedCount++;
                }
            });

            canvas.renderAll();
            
            if (addedCount > 0) {
                toast(`‚úÖ Added ${addedCount} fields to badge!`);
            } else {
                toast('‚ö†Ô∏è No field values to add');
            }
        }

        // ============================================
        // EXCEL TEMPLATE DOWNLOAD
        // ============================================
        
        function downloadExcelTemplate() {
            // Get all custom field labels
            const fields = document.querySelectorAll('.field-label');
            const headers = [];
            
            fields.forEach(field => {
                const label = field.value.trim();
                if (label) {
                    headers.push(label);
                }
            });

            if (headers.length === 0) {
                toast('‚ö†Ô∏è No custom fields to generate template');
                return;
            }

            // Create worksheet with headers
            const ws_data = [headers];
            
            // Add 3 example rows
            for (let i = 0; i < 3; i++) {
                const row = headers.map(h => `Sample ${i + 1}`);
                ws_data.push(row);
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Badge Data");

            // Download
            XLSX.writeFile(wb, 'badge_template.xlsx');
            
            toast('‚úÖ Excel template downloaded!');
        }

        // ============================================
        // EXCEL BULK UPLOAD
        // ============================================
        
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Store the file for later upload to Cloudinary
            window.bulkExcelFile = file;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                excelData = jsonData;
                
                document.getElementById('excelFileName').textContent = file.name;
                document.getElementById('excelRowCount').textContent = jsonData.length;
                document.getElementById('excelSection').style.display = 'block';
                
                // Show bulk photos section if bulk order is selected
                const orderType = document.querySelector('input[name="orderType"]:checked').value;
                if (orderType === 'bulk1' || orderType === 'bulk2') {
                    document.getElementById('bulkPhotosSection').style.display = 'block';
                }

                toast(`‚úÖ Excel uploaded: ${jsonData.length} records found`);
            };
            reader.readAsArrayBuffer(file);
        }

        // Store bulk photos for upload
        window.bulkPhotosFiles = [];

        function handleBulkPhotosUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            window.bulkPhotosFiles = Array.from(files);
            
            document.getElementById('bulkPhotosCount').textContent = files.length;
            
            // Show file names
            const listDiv = document.getElementById('bulkPhotosList');
            listDiv.innerHTML = window.bulkPhotosFiles.map(f => `‚Ä¢ ${f.name}`).join('<br>');
            
            document.getElementById('bulkPhotosPreview').style.display = 'block';
            
            toast(`‚úÖ ${files.length} photos uploaded`);
        }

        // ============================================
        // CANVAS MANAGEMENT
        // ============================================
        
        function switchToFront() {
            saveCurrentSide();
            currentSide = 'front';
            loadSide('front');
            updateTabs();
            
            // Update magnetic stripe visual (will remove it on front side)
            updateMagneticStripeVisual();
            
            // Hide back side warning
            document.getElementById('backSideWarning').style.display = 'none';
            
            // Enable color controls for front side
            enableColorControls();
            
            toast('üìÑ Front side');
        }

        function switchToBack() {
            // Check if single-sided is selected
            const style = document.getElementById('badgeStyle').value;
            if (style === 'single') {
                toast('‚ö†Ô∏è Back side disabled for single-sided badges');
                return;
            }
            
            saveCurrentSide();
            currentSide = 'back';
            loadSide('back');
            updateTabs();
            
            // Update magnetic stripe visual (will show if conditions met)
            updateMagneticStripeVisual();
            
            // Show back side warning
            document.getElementById('backSideWarning').style.display = 'block';
            
            // Disable color controls for back side
            disableColorControls();
            
            toast('üìÑ Back side - Black only');
        }

        // ============================================
        // BACK SIDE COLOR RESTRICTIONS
        // ============================================
        
        function disableColorControls() {
            // Disable text color picker
            const textColor = document.getElementById('textColor');
            if (textColor) {
                textColor.value = '#000000';
                textColor.disabled = true;
                textColor.style.opacity = '0.5';
                textColor.style.cursor = 'not-allowed';
            }
            
            // Disable shape color picker
            const shapeColor = document.getElementById('shapeFillColor');
            if (shapeColor) {
                shapeColor.value = '#000000';
                shapeColor.disabled = true;
                shapeColor.style.opacity = '0.5';
                shapeColor.style.cursor = 'not-allowed';
            }
            
            // Disable photo and logo buttons
            const photoBtn = document.querySelector('button[onclick*="photoInput"]');
            const logoBtn = document.querySelector('button[onclick*="logoInput"]');
            
            if (photoBtn) {
                photoBtn.disabled = true;
                photoBtn.style.opacity = '0.5';
                photoBtn.style.cursor = 'not-allowed';
                photoBtn.title = 'Photos not available on back side';
            }
            
            if (logoBtn) {
                logoBtn.disabled = true;
                logoBtn.style.opacity = '0.5';
                logoBtn.style.cursor = 'not-allowed';
                logoBtn.title = 'Logos not available on back side';
            }
            
            // Disable background image button
            const bgBtn = document.querySelector('button[onclick*="backgroundInput"]');
            if (bgBtn) {
                bgBtn.disabled = true;
                bgBtn.style.opacity = '0.5';
                bgBtn.style.cursor = 'not-allowed';
                bgBtn.title = 'Background images not available on back side';
            }
        }
        
        function enableColorControls() {
            // Enable text color picker
            const textColor = document.getElementById('textColor');
            if (textColor) {
                textColor.disabled = false;
                textColor.style.opacity = '1';
                textColor.style.cursor = 'pointer';
            }
            
            // Enable shape color picker
            const shapeColor = document.getElementById('shapeFillColor');
            if (shapeColor) {
                shapeColor.disabled = false;
                shapeColor.style.opacity = '1';
                shapeColor.style.cursor = 'pointer';
            }
            
            // Enable photo and logo buttons
            const photoBtn = document.querySelector('button[onclick*="photoInput"]');
            const logoBtn = document.querySelector('button[onclick*="logoInput"]');
            
            if (photoBtn) {
                photoBtn.disabled = false;
                photoBtn.style.opacity = '1';
                photoBtn.style.cursor = 'pointer';
                photoBtn.title = '';
            }
            
            if (logoBtn) {
                logoBtn.disabled = false;
                logoBtn.style.opacity = '1';
                logoBtn.style.cursor = 'pointer';
                logoBtn.title = '';
            }
            
            // Enable background image button
            const bgBtn = document.querySelector('button[onclick*="backgroundInput"]');
            if (bgBtn) {
                bgBtn.disabled = false;
                bgBtn.style.opacity = '1';
                bgBtn.style.cursor = 'pointer';
                bgBtn.title = '';
            }
        }

        function saveCurrentSide() {
            const json = canvas.toJSON();
            if (currentSide === 'front') {
                frontDesign = json;
            } else {
                backDesign = json;
            }
        }

        function loadSide(side) {
            const design = (side === 'front') ? frontDesign : backDesign;
            
            if (design) {
                canvas.loadFromJSON(design, function() {
                    // Restore background reference - look for isBackground property first
                    const bgObj = canvas.getObjects().find(obj => obj.isBackground === true) ||
                                  canvas.getObjects().find(obj => obj.selectable === false && obj.evented === false && obj.type === 'image');
                    if (bgObj) {
                        backgroundImage = bgObj;
                        // Ensure background properties are set correctly
                        bgObj.set({
                            selectable: false,
                            evented: false,
                            lockMovementX: true,
                            lockMovementY: true,
                            isBackground: true
                        });
                        // Ensure background is at back
                        canvas.sendToBack(bgObj);
                    } else {
                        backgroundImage = null;
                    }
                    
                    // Restore slot visual if needed
                    updateSlotVisual();
                    
                    // Remove any old magnetic stripe objects from loaded design and add current one if needed
                    // This ensures the stripe matches current card type settings
                    const objects = canvas.getObjects();
                    for (let i = objects.length - 1; i >= 0; i--) {
                        const obj = objects[i];
                        // Remove any black rectangles at the top that might be old magnetic stripes
                        if (obj.type === 'rect' && obj.fill === '#000000' && 
                            obj.top === 40 * SCALE && obj.height === 130 * SCALE &&
                            obj.selectable === false && obj.evented === false) {
                            canvas.remove(obj);
                        }
                    }
                    
                    // Add magnetic stripe if conditions are met
                    updateMagneticStripeVisual();
                    
                    // Check canvas content for checkout button
                    checkCanvasContent();
                    
                    canvas.renderAll();
                });
            } else {
                canvas.clear();
                canvas.backgroundColor = '#ffffff';
                backgroundImage = null;
                slotObject = null;
                magneticStripeObject = null;
                
                // Add slot visual if selected
                updateSlotVisual();
                
                // Add magnetic stripe if conditions are met
                updateMagneticStripeVisual();
                
                // Check canvas content for checkout button
                checkCanvasContent();
                
                canvas.renderAll();
            }
        }

        function updateTabs() {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            if (currentSide === 'front') {
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
            }
        }

        function changeOrientation() {
            const orientation = document.getElementById('orientation').value;
            
            if (orientation === 'portrait') {
                canvas.setWidth(BADGE_HEIGHT * SCALE);
                canvas.setHeight(BADGE_WIDTH * SCALE);
                
                // Refit background if exists
                if (backgroundImage) {
                    const scaleX = (BADGE_HEIGHT * SCALE) / (backgroundImage.width / backgroundImage.scaleX);
                    const scaleY = (BADGE_WIDTH * SCALE) / (backgroundImage.height / backgroundImage.scaleY);
                    backgroundImage.set({ scaleX: scaleX, scaleY: scaleY });
                }
                
                toast('üì± Portrait');
            } else {
                canvas.setWidth(BADGE_WIDTH * SCALE);
                canvas.setHeight(BADGE_HEIGHT * SCALE);
                
                // Refit background if exists
                if (backgroundImage) {
                    const scaleX = (BADGE_WIDTH * SCALE) / (backgroundImage.width / backgroundImage.scaleX);
                    const scaleY = (BADGE_HEIGHT * SCALE) / (backgroundImage.height / backgroundImage.scaleY);
                    backgroundImage.set({ scaleX: scaleX, scaleY: scaleY });
                }
                
                toast('üñ•Ô∏è Landscape');
            }
            
            // Update slot position if present
            updateSlotVisual();
            
            // Update magnetic stripe position if present
            updateMagneticStripeVisual();
            
            canvas.renderAll();
        }

        function deleteSelectedElement() {
            const obj = canvas.getActiveObject();
            if (obj) {
                canvas.remove(obj);
                canvas.renderAll();
                toast('‚úÖ Deleted');
            }
        }

        function clearCurrentCanvas() {
            if (confirm(`Clear ${currentSide} side?`)) {
                canvas.clear();
                canvas.backgroundColor = '#ffffff';
                backgroundImage = null;
                slotObject = null;
                magneticStripeObject = null;
                
                // Restore slot visual if needed
                updateSlotVisual();
                
                // Restore magnetic stripe visual if needed
                updateMagneticStripeVisual();
                
                canvas.renderAll();
                
                if (currentSide === 'front') {
                    frontDesign = null;
                } else {
                    backDesign = null;
                }
                
                toast(`‚úÖ ${currentSide} cleared`);
            }
        }

        // ============================================
        // EXPORT & CHECKOUT
        // ============================================
        
        function exportBothSides() {
            saveCurrentSide();

            if (frontDesign) {
                canvas.loadFromJSON(frontDesign, function() {
                    const dataUrl = canvas.toDataURL({
                        format: 'png',
                        multiplier: 1 / SCALE,
                        quality: 1
                    });
                    downloadFile(dataUrl, 'badge-front-300dpi.png');
                });
            }

            setTimeout(() => {
                if (backDesign) {
                    canvas.loadFromJSON(backDesign, function() {
                        const dataUrl = canvas.toDataURL({
                            format: 'png',
                            multiplier: 1 / SCALE,
                            quality: 1
                        });
                        downloadFile(dataUrl, 'badge-back-300dpi.png');
                        loadSide(currentSide);
                    });
                }
            }, 500);

            toast('‚úÖ Downloading files...');
        }

        function downloadFile(dataUrl, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataUrl;
            link.click();
        }

        // ============================================
        // DOWNLOAD CARD SPECIFICATION
        // ============================================
        
        function downloadCardSpecification() {
            // Gather all specification data
            const badgeStyle = document.getElementById('badgeStyle').value;
            const cardType = document.getElementById('cardType').value;
            const orientation = document.getElementById('orientation').value;
            const holeSlot = document.getElementById('holeSlot').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const totalPrice = document.getElementById('totalPrice').textContent;
            const deliveryDate = document.getElementById('deliveryDate').value || 'Not specified';
            const proofApproval = document.getElementById('proofApproval').checked;
            const additionalInstructions = document.getElementById('additionalInstructions').value || 'None';
            
            // Determine order type
            let orderType = 'Single Badge';
            if (excelData && excelData.length > 0) {
                orderType = `Bulk Order (${excelData.length} badges from Excel)`;
            } else if (quantity > 1) {
                orderType = `Multiple Badges (${quantity} copies)`;
            }
            
            // Get custom fields information
            const customFieldsContainer = document.getElementById('customFieldsList');
            const customFieldRows = customFieldsContainer.querySelectorAll('.custom-field-row');
            let customFieldsInfo = '';
            
            if (customFieldRows.length > 0) {
                customFieldsInfo = '\nCUSTOM FIELDS:\n';
                customFieldsInfo += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                customFieldRows.forEach((row, index) => {
                    const labelInput = row.querySelector('.custom-field-input:first-child');
                    const valueInput = row.querySelector('.custom-field-input:last-child');
                    const label = labelInput ? labelInput.value : 'Unnamed Field';
                    const value = valueInput ? valueInput.value : 'No Value';
                    
                    customFieldsInfo += `${index + 1}. Field Label: ${label}\n`;
                    customFieldsInfo += `   Field Value: ${value}\n`;
                    
                    // Try to get font information from canvas objects
                    const canvasObjects = canvas.getObjects();
                    const textObj = canvasObjects.find(obj => 
                        (obj.type === 'i-text' || obj.type === 'text') && 
                        obj.text && obj.text.includes(label)
                    );
                    
                    if (textObj) {
                        customFieldsInfo += `   Font Family: ${textObj.fontFamily || 'Arial'}\n`;
                        customFieldsInfo += `   Font Size: ${Math.round(textObj.fontSize / SCALE)}px\n`;
                        customFieldsInfo += `   Font Weight: ${textObj.fontWeight || 'normal'}\n`;
                        customFieldsInfo += `   Font Color: ${textObj.fill || '#000000'}\n`;
                    }
                    customFieldsInfo += '\n';
                });
            } else {
                customFieldsInfo = '\nCUSTOM FIELDS: None\n';
            }
            
            // Format style names
            const styleName = badgeStyle === 'single' ? 'Single Sided' : 'Double Sided (Front & Back) +$1.00';
            const cardTypeName = cardType === 'standard' ? 
                'Standard CR80 ID Card (2.125" x 3.375")' : 
                'Standard CR80 ID Card with Magnetic Stripe';
            const orientationName = orientation === 'landscape' ? 'Landscape (Horizontal)' : 'Portrait (Vertical)';
            const holeSlotName = holeSlot === 'none' ? 'No Slot' : 'Standard Oval Hole';
            
            // Create the specification text content
            const specContent = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    MAGICCARDPRINT BADGE DESIGNER - CARD SPECIFICATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Generated: ${new Date().toLocaleString()}

CARD SPECIFICATIONS:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Style:           ${styleName}
Card Type:       ${cardTypeName}
Orientation:     ${orientationName}
Hole/Slot:       ${holeSlotName}
${customFieldsInfo}
ORDER DETAILS:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Order Type:      ${orderType}
Quantity:        ${quantity} badge(s)
Total Cost:      ${totalPrice}

DELIVERY INFORMATION:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Delivery Date:   ${deliveryDate}
Proof Approval:  ${proofApproval ? 'YES - Please send proof before production' : 'NO - Proceed without proof'}

ADDITIONAL INSTRUCTIONS:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${additionalInstructions}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    END OF SPECIFICATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

NOTE: This specification file contains all the settings and
      customizations configured in the MagicCardPrint Badge Designer.
      Please review carefully before placing your order.

MagicCardPrint - Professional ID Card Printing Solutions
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;

            // Create blob and download
            const blob = new Blob([specContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `MagicCardPrint_Card_Specification_${timestamp}.txt`;
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            toast('‚úÖ Card specification downloaded successfully!');
        }

        function checkout() {
            saveCurrentSide();
            
            // Check if bulk order is selected
            const orderType = document.querySelector('input[name="orderType"]:checked').value;
            const isBulkOrder = (orderType === 'bulk1' || orderType === 'bulk2');
            
            // Validate bulk order requirements
            if (isBulkOrder) {
                // Check if Excel file is uploaded
                if (!window.bulkExcelFile || !excelData || excelData.length === 0) {
                    alert('‚ö†Ô∏è BULK ORDER REQUIREMENT\n\nYou have selected a Bulk Order pricing tier, but no Excel file has been uploaded.\n\nPlease:\n1. Download the Excel Template\n2. Fill in your badge data (names, IDs, positions, etc.)\n3. Upload the completed Excel file\n4. Try checkout again\n\nThe Excel file tells us what unique information to print on each badge.');
                    return;
                }
                
                // Check if bulk confirmation checkbox is checked
                const bulkConfirmCheckbox = document.getElementById('bulkExcelConfirm');
                if (!bulkConfirmCheckbox.checked) {
                    alert('‚ö†Ô∏è BULK ORDER CONFIRMATION REQUIRED\n\nPlease check the box to confirm:\n"I have uploaded my bulk order Excel file with all badge data"\n\nThis ensures we have all the information needed to print your badges correctly.');
                    
                    // Scroll to and highlight the checkbox
                    document.getElementById('bulkOrderConfirmation').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    document.getElementById('bulkOrderConfirmation').style.boxShadow = '0 0 10px #2196F3';
                    setTimeout(() => {
                        document.getElementById('bulkOrderConfirmation').style.boxShadow = 'none';
                    }, 3000);
                    return;
                }
            }
            
            // Update checkout modal with current values
            const quantity = document.getElementById('quantity').value;
            const unitPrice = document.getElementById('unitPrice').textContent;
            const totalPrice = document.getElementById('totalPrice').textContent;
            
            document.getElementById('checkoutQuantity').textContent = quantity;
            document.getElementById('checkoutUnitPrice').textContent = unitPrice;
            document.getElementById('checkoutTotal').textContent = totalPrice;
            
            // Reset modal state
            document.getElementById('checkoutStep1').style.display = 'block';
            document.getElementById('checkoutStep2').style.display = 'none';
            document.getElementById('checkoutStep3').style.display = 'none';
            document.getElementById('checkoutError').style.display = 'none';
            
            // Clear form
            document.getElementById('checkoutName').value = '';
            document.getElementById('checkoutEmail').value = '';
            
            // Show modal
            document.getElementById('checkoutModal').classList.add('show');
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').classList.remove('show');
        }

        // ============================================
        // PREVIEW LAYOUT FUNCTIONS
        // ============================================
        
        let previewImages = { front: null, back: null };
        
        function openPreview() {
            // Save current work first
            saveCurrentSide();
            
            // Generate preview for current side only (don't switch sides)
            const currentPreview = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: 2  // 2x for better preview quality
            });
            
            // Store preview for current side
            if (currentSide === 'front') {
                previewImages.front = currentPreview;
                // Use saved back design if available
                if (backDesign) {
                    previewImages.back = generatePreviewFromJSON(backDesign);
                } else {
                    previewImages.back = null;
                }
            } else {
                previewImages.back = currentPreview;
                // Use saved front design if available
                if (frontDesign) {
                    previewImages.front = generatePreviewFromJSON(frontDesign);
                } else {
                    previewImages.front = null;
                }
            }
            
            // Show the current side first
            showPreviewSide(currentSide);
            document.getElementById('previewModal').classList.add('show');
        }
        
        function generatePreviewFromJSON(designJSON) {
            // Create a temporary canvas to generate preview from saved JSON
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = BADGE_WIDTH * SCALE * 2;
            tempCanvas.height = BADGE_HEIGHT * SCALE * 2;
            
            const tempFabricCanvas = new fabric.StaticCanvas(tempCanvas, {
                width: BADGE_WIDTH * SCALE,
                height: BADGE_HEIGHT * SCALE,
                backgroundColor: '#ffffff'
            });
            
            return new Promise((resolve) => {
                tempFabricCanvas.loadFromJSON(designJSON, function() {
                    tempFabricCanvas.renderAll();
                    const dataUrl = tempFabricCanvas.toDataURL({
                        format: 'png',
                        quality: 1,
                        multiplier: 2
                    });
                    tempFabricCanvas.dispose();
                    resolve(dataUrl);
                });
            });
        }
        
        async function showPreviewSide(side) {
            // Update button styles
            const frontBtn = document.getElementById('previewFrontBtn');
            const backBtn = document.getElementById('previewBackBtn');
            
            if (side === 'front') {
                frontBtn.className = 'btn btn-primary';
                frontBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                backBtn.className = 'btn btn-secondary';
                backBtn.style.background = '#6c757d';
            } else {
                frontBtn.className = 'btn btn-secondary';
                frontBtn.style.background = '#6c757d';
                backBtn.className = 'btn btn-primary';
                backBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
            
            // Check if double-sided is enabled
            const badgeStyle = document.getElementById('badgeStyle').value;
            if (side === 'back' && badgeStyle === 'single') {
                toast('‚ö†Ô∏è Back side is disabled for single-sided badges');
                showPreviewSide('front');
                return;
            }
            
            const previewImg = document.getElementById('previewImage');
            
            if (side === 'front') {
                if (previewImages.front) {
                    // If it's a promise, await it
                    if (previewImages.front instanceof Promise) {
                        previewImages.front = await previewImages.front;
                    }
                    previewImg.src = previewImages.front;
                } else {
                    previewImg.src = '';
                    toast('‚ö†Ô∏è No front design available');
                }
            } else {
                if (previewImages.back) {
                    // If it's a promise, await it
                    if (previewImages.back instanceof Promise) {
                        previewImages.back = await previewImages.back;
                    }
                    previewImg.src = previewImages.back;
                } else {
                    previewImg.src = '';
                    toast('‚ö†Ô∏è No back design available - switch to Back Side tab to create one');
                }
            }
        }
        
        function closePreview() {
            document.getElementById('previewModal').classList.remove('show');
            // Clear preview images to free memory
            previewImages = { front: null, back: null };
        }

        function retryCheckout() {
            document.getElementById('checkoutStep1').style.display = 'block';
            document.getElementById('checkoutError').style.display = 'none';
        }

        function generateReferenceId() {
            const date = new Date();
            const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `MCP-${dateStr}-${random}`;
        }
        
        // Direct upload to Cloudinary (bypasses Vercel size limits)
        async function uploadToCloudinaryDirect(file, folder, publicId) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            formData.append('folder', folder);
            if (publicId) {
                formData.append('public_id', publicId);
            }
            
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Failed to upload to Cloudinary');
            }
            
            return await response.json();
        }
        
        // Convert base64 to blob for Cloudinary upload
        function base64ToBlob(base64, mimeType) {
            const byteString = atob(base64.split(',')[1]);
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeType });
        }

        async function processCheckout() {
            const name = document.getElementById('checkoutName').value.trim();
            const email = document.getElementById('checkoutEmail').value.trim();
            
            // Validate
            if (!name || !email) {
                toast('‚ö†Ô∏è Please fill in all required fields');
                return;
            }
            
            if (!email.includes('@')) {
                toast('‚ö†Ô∏è Please enter a valid email address');
                return;
            }
            
            // Show processing step
            document.getElementById('checkoutStep1').style.display = 'none';
            document.getElementById('checkoutStep2').style.display = 'block';
            document.getElementById('checkoutStatus').textContent = 'Preparing your design...';
            
            try {
                // Generate reference ID
                const referenceId = generateReferenceId();
                const folder = `magiccardprint/${referenceId}`;
                
                // Get badge specifications
                const badgeStyle = document.getElementById('badgeStyle').value;
                const cardType = document.getElementById('cardType').value;
                const orientation = document.getElementById('orientation').value;
                const holeSlot = document.getElementById('holeSlot').value;
                const quantity = parseInt(document.getElementById('quantity').value) || 1;
                const proofApproval = document.getElementById('proofApproval').checked;
                const deliveryDate = document.getElementById('deliveryDate').value;
                const additionalInstructions = document.getElementById('additionalInstructions').value;
                const orderType = document.querySelector('input[name="orderType"]:checked').value;
                const isBulkOrder = (orderType === 'bulk1' || orderType === 'bulk2');
                
                // Get card type description
                let cardTypeDesc = 'Standard CR80';
                if (cardType === 'magnetic') cardTypeDesc = 'CR80 with Magnetic Stripe (+$3.00)';
                if (cardType === 'adhesive') cardTypeDesc = 'CR80 Adhesive Cards PVC Overlays';
                
                const specifications = {
                    badgeStyle: badgeStyle === 'single' ? 'Single Sided' : 'Double Sided (+$1.00)',
                    cardType: cardTypeDesc,
                    orientation: orientation === 'landscape' ? 'Landscape' : 'Portrait',
                    holeSlot: holeSlot === 'none' ? 'No Slot' : 'Standard Oval Hole',
                    proofApproval: proofApproval,
                    deliveryDate: deliveryDate || 'Standard',
                    additionalInstructions: additionalInstructions || 'None',
                    orderType: orderType === 'single' ? 'Single Badge ($30)' : 
                               orderType === 'bulk1' ? 'Bulk Order 2-50 ($15 each)' : 
                               'Bulk Order 51-100+ ($12 each)',
                    isBulkOrder: isBulkOrder,
                    bulkRecordCount: isBulkOrder && excelData ? excelData.length : 0,
                    bulkExcelFileName: isBulkOrder && window.bulkExcelFile ? window.bulkExcelFile.name : null,
                    bulkPhotosCount: isBulkOrder && window.bulkPhotosFiles ? window.bulkPhotosFiles.length : 0,
                    hasArtwork: window.artworkUploaded || false,
                    artworkFilesCount: window.artworkFilesData ? window.artworkFilesData.length : 0
                };
                
                // Get front image from canvas at FULL PRINT RESOLUTION
                saveCurrentSide();
                const frontTab = document.querySelector('.tab.active');
                const wasOnBack = frontTab && frontTab.textContent.includes('Back');
                
                // Make sure we're on the front side first
                if (wasOnBack) {
                    switchToFront();
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                // Export front at full resolution (1012 √ó 638) for print quality
                const frontImage = canvas.toDataURL({
                    format: 'png',
                    quality: 1,
                    multiplier: 1 / SCALE  // Scale back up to full size
                });
                
                // Get back image if double-sided
                let backImage = null;
                if (badgeStyle === 'double') {
                    // Switch to back side to export it
                    switchToBack();
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Export back at full resolution
                    backImage = canvas.toDataURL({
                        format: 'png',
                        quality: 1,
                        multiplier: 1 / SCALE
                    });
                    
                    // Switch back to front
                    switchToFront();
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Track uploaded file URLs
                const uploadedFiles = [];
                
                // Upload front design directly to Cloudinary
                document.getElementById('checkoutStatus').textContent = 'Uploading front design...';
                const frontBlob = base64ToBlob(frontImage, 'image/png');
                const frontFile = new File([frontBlob], 'front.png', { type: 'image/png' });
                const frontResult = await uploadToCloudinaryDirect(frontFile, folder, 'front');
                uploadedFiles.push({ type: 'front', url: frontResult.secure_url });
                
                // Upload back design if exists
                if (backImage) {
                    document.getElementById('checkoutStatus').textContent = 'Uploading back design...';
                    const backBlob = base64ToBlob(backImage, 'image/png');
                    const backFile = new File([backBlob], 'back.png', { type: 'image/png' });
                    const backResult = await uploadToCloudinaryDirect(backFile, folder, 'back');
                    uploadedFiles.push({ type: 'back', url: backResult.secure_url });
                }
                
                // Upload Excel file if bulk order
                if (isBulkOrder && window.bulkExcelFile) {
                    document.getElementById('checkoutStatus').textContent = 'Uploading Excel data...';
                    try {
                        const excelResult = await uploadToCloudinaryDirect(window.bulkExcelFile, folder, 'bulk-data');
                        uploadedFiles.push({ type: 'excel', url: excelResult.secure_url });
                    } catch (e) {
                        console.error('Excel upload error:', e);
                        // Continue even if Excel upload fails
                    }
                }
                
                // Upload bulk photos directly to Cloudinary (bypasses Vercel limits)
                if (isBulkOrder && window.bulkPhotosFiles && window.bulkPhotosFiles.length > 0) {
                    const photosFolder = `${folder}/photos`;
                    for (let i = 0; i < window.bulkPhotosFiles.length; i++) {
                        const photoFile = window.bulkPhotosFiles[i];
                        document.getElementById('checkoutStatus').textContent = `Uploading photo ${i + 1} of ${window.bulkPhotosFiles.length}...`;
                        try {
                            const photoName = photoFile.name.replace(/\.[^/.]+$/, '');
                            const photoResult = await uploadToCloudinaryDirect(photoFile, photosFolder, photoName);
                            uploadedFiles.push({ type: 'photo', name: photoFile.name, url: photoResult.secure_url });
                        } catch (e) {
                            console.error(`Photo upload error for ${photoFile.name}:`, e);
                            // Continue with other photos
                        }
                    }
                }
                
                // Upload artwork files directly to Cloudinary
                if (window.artworkUploaded && window.artworkFilesData && window.artworkFilesData.length > 0) {
                    const artworkFolder = `${folder}/artwork`;
                    for (let i = 0; i < window.artworkFilesData.length; i++) {
                        const artwork = window.artworkFilesData[i];
                        document.getElementById('checkoutStatus').textContent = `Uploading artwork ${i + 1} of ${window.artworkFilesData.length}...`;
                        try {
                            const artworkBlob = base64ToBlob(artwork.data, 'image/png');
                            const artworkName = artwork.name.replace(/\.[^/.]+$/, '');
                            const artworkFile = new File([artworkBlob], artwork.name, { type: 'image/png' });
                            const artworkResult = await uploadToCloudinaryDirect(artworkFile, artworkFolder, artworkName);
                            uploadedFiles.push({ type: 'artwork', name: artwork.name, url: artworkResult.secure_url });
                        } catch (e) {
                            console.error(`Artwork upload error for ${artwork.name}:`, e);
                            // Continue with other artwork files
                        }
                    }
                }
                
                // Upload specifications as JSON
                document.getElementById('checkoutStatus').textContent = 'Saving order details...';
                const specContent = {
                    referenceId,
                    customerName: name,
                    customerEmail: email,
                    specifications,
                    uploadedFiles,
                    uploadedAt: new Date().toISOString()
                };
                const specBlob = new Blob([JSON.stringify(specContent, null, 2)], { type: 'application/json' });
                const specFile = new File([specBlob], 'specifications.json', { type: 'application/json' });
                await uploadToCloudinaryDirect(specFile, folder, 'specifications');
                
                // Create Square checkout
                document.getElementById('checkoutStatus').textContent = 'Creating your order...';
                
                // Parse unit price (remove $ sign and convert to number)
                const unitPriceText = document.getElementById('unitPrice').textContent;
                const unitPrice = parseFloat(unitPriceText.replace('$', ''));
                
                const checkoutResponse = await fetch('/api/create-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        referenceId: referenceId,
                        customerName: name,
                        customerEmail: email,
                        quantity: quantity,
                        unitPrice: unitPrice,
                        itemName: `Custom ID Badge (${specifications.badgeStyle})`,
                        specifications: JSON.stringify(specifications),
                        redirectUrl: 'https://magiccardprint-designer.vercel.app/thank-you.html'
                    })
                });
                
                if (!checkoutResponse.ok) {
                    let errorMsg = 'Failed to create checkout';
                    try {
                        const errorData = await checkoutResponse.json();
                        errorMsg = errorData.details || errorMsg;
                    } catch (e) {
                        // Response wasn't JSON
                        errorMsg = `Server error (${checkoutResponse.status})`;
                    }
                    throw new Error(errorMsg);
                }
                
                const checkoutResult = await checkoutResponse.json();
                
                // Show success and redirect
                document.getElementById('checkoutStep2').style.display = 'none';
                document.getElementById('checkoutStep3').style.display = 'block';
                document.getElementById('checkoutRefId').textContent = referenceId;
                
                // Clear design flag so no exit warning shows
                hasDesignContent = false;
                
                // Redirect to Square checkout after 2 seconds
                setTimeout(() => {
                    window.location.href = checkoutResult.checkoutUrl;
                }, 2000);
                
            } catch (error) {
                console.error('Checkout error:', error);
                document.getElementById('checkoutStep2').style.display = 'none';
                document.getElementById('checkoutError').style.display = 'block';
                document.getElementById('checkoutErrorMsg').textContent = error.message || 'Please try again or contact support.';
            }
        }

        // ============================================
        // PRICING LOGIC
        // ============================================
        
        function updatePriceByType() {
            const qty = parseInt(document.getElementById('quantity').value) || 1;
            let unit = 30.00; // Default to single piece
            
            // Get selected order type
            const orderType = document.querySelector('input[name="orderType"]:checked').value;
            
            if (orderType === 'single') {
                // Single piece pricing
                unit = 30.00;
                // Lock quantity to 1 for single piece
                document.getElementById('quantity').value = 1;
                document.getElementById('quantity').max = 1;
                // Hide bulk order confirmation
                document.getElementById('bulkOrderConfirmation').style.display = 'none';
                // Hide bulk photos section
                document.getElementById('bulkPhotosSection').style.display = 'none';
            } else if (orderType === 'bulk1') {
                // Bulk 2-50 pricing
                unit = 15.00;
                document.getElementById('quantity').max = 50;
                // Validate quantity range
                if (qty < 2) {
                    document.getElementById('quantity').value = 2;
                } else if (qty > 50) {
                    document.getElementById('quantity').value = 50;
                }
                // Show bulk order confirmation
                document.getElementById('bulkOrderConfirmation').style.display = 'block';
                // Show bulk photos section if Excel uploaded
                if (window.bulkExcelFile) {
                    document.getElementById('bulkPhotosSection').style.display = 'block';
                }
            } else if (orderType === 'bulk2') {
                // Bulk 51-100+ pricing
                unit = 12.00;
                document.getElementById('quantity').min = 51;
                document.getElementById('quantity').max = 500;
                // Validate quantity range
                if (qty < 51) {
                    document.getElementById('quantity').value = 51;
                }
                // Show bulk order confirmation
                document.getElementById('bulkOrderConfirmation').style.display = 'block';
                // Show bulk photos section if Excel uploaded
                if (window.bulkExcelFile) {
                    document.getElementById('bulkPhotosSection').style.display = 'block';
                }
            }
            
            // Add double-sided upcharge
            unit += doubleSidedUpcharge;
            
            // Add magnetic stripe upcharge
            unit += magneticStripeUpcharge;
            
            const finalQty = parseInt(document.getElementById('quantity').value) || 1;
            
            document.getElementById('unitPrice').textContent = '$' + unit.toFixed(2);
            document.getElementById('totalPrice').textContent = '$' + (unit * finalQty).toFixed(2);
        }
        
        // Update card type and pricing
        function updateCardType() {
            const cardType = document.getElementById('cardType').value;
            const magneticPriceNote = document.getElementById('magneticPriceNote');
            
            if (cardType === 'magnetic') {
                magneticStripeUpcharge = 3.00;
                magneticPriceNote.style.display = 'block';
            } else {
                magneticStripeUpcharge = 0;
                magneticPriceNote.style.display = 'none';
            }
            
            updateMagneticStripeVisual();
            enforceMagneticStripeRestrictions();
            updatePriceByType();
        }
        
        // Check if canvas has user content (for enabling checkout)
        function checkCanvasContent() {
            const objects = canvas.getObjects();
            // Filter out system objects (slot, magnetic stripe)
            const userObjects = objects.filter(obj => {
                // Exclude slot object
                if (obj === slotObject) return false;
                // Exclude magnetic stripe object
                if (obj === magneticStripeObject) return false;
                // Exclude background that is non-selectable
                if (obj === backgroundImage) return false;
                return true;
            });
            
            hasDesignContent = userObjects.length > 0 || backgroundImage !== null;
            
            const checkoutBtn = document.getElementById('checkoutBtn');
            const checkoutMsg = document.getElementById('checkoutDisabledMsg');
            
            if (hasDesignContent) {
                checkoutBtn.disabled = false;
                checkoutBtn.style.opacity = '1';
                checkoutBtn.style.cursor = 'pointer';
                checkoutMsg.style.display = 'none';
            } else {
                checkoutBtn.disabled = true;
                checkoutBtn.style.opacity = '0.5';
                checkoutBtn.style.cursor = 'not-allowed';
                checkoutMsg.style.display = 'block';
            }
            
            return hasDesignContent;
        }
        
        // Confirm exit function
        function confirmExit() {
            if (hasDesignContent) {
                if (confirm('Are you sure you want to exit the designer? Your design will not be saved.')) {
                    window.location.href = 'https://magiccardprint.square.site';
                }
            } else {
                window.location.href = 'https://magiccardprint.square.site';
            }
        }
        
        // Warn before page unload if design exists
        window.addEventListener('beforeunload', function(e) {
            if (hasDesignContent) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        function toast(message) {
            const t = document.getElementById('toast');
            t.textContent = message;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
